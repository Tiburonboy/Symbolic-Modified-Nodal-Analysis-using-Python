<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.537">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Symbolic Modified Nodal Analysisusing Python - 20&nbsp; Two amplifier RIAA phono preamp</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./Two port parameters.html" rel="next">
<link href="./Example-problems.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./Example-problems.html">Example problems</a></li><li class="breadcrumb-item"><a href="./Two amplifier RIAA Phono Preamp.html"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Two amplifier RIAA phono preamp</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Symbolic Modified Nodal Analysis<br>using Python</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">About this book</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Preface.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Introduction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Theory.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Theory</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./SMNA_example.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">SMNA Example</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./SMNA-function.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">SMNA function</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./Validation-tests.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Validation tests</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./test_1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Test 1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./test_2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">test_2</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./test_3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">test_3</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./test_4.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">test_4</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./test_5.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">test_5</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./test_6.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">test_6</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./test_7.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">test_7</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./test_8.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">test_8</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./test_9.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">test_9</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./test_10.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">test_10</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./test_11.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">test_11</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./test_12.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">test_12</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./test_13.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">test_13</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./test_14.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">test_14</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./test_15.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">test_15</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./Example-problems.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Example problems</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Two amplifier RIAA Phono Preamp.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Two amplifier RIAA phono preamp</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Two port parameters.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Two port parameters</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Thevenin equivalent circuit.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">Thevenin equivalent circuit</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./State-variable-filter.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">23</span>&nbsp; <span class="chapter-title">State Variable Filter</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Superposition_and_polyphase_circuit.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">24</span>&nbsp; <span class="chapter-title">A polyphase circuit</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./2nd_order_BRF.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">25</span>&nbsp; <span class="chapter-title">2nd Order BRF</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Elliptic-function-LPF.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">26</span>&nbsp; <span class="chapter-title">Elliptic Function LPF</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./References.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./SymMNA_py.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">SymMNA.py</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Change-log.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">Change Log</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#abstract" id="toc-abstract" class="nav-link active" data-scroll-target="#abstract">Abstract</a></li>
  <li><a href="#introduction" id="toc-introduction" class="nav-link" data-scroll-target="#introduction"><span class="header-section-number">20.1</span> Introduction</a>
  <ul class="collapse">
  <li><a href="#scope" id="toc-scope" class="nav-link" data-scroll-target="#scope"><span class="header-section-number">20.1.1</span> Scope</a></li>
  <li><a href="#methodology" id="toc-methodology" class="nav-link" data-scroll-target="#methodology"><span class="header-section-number">20.1.2</span> Methodology</a></li>
  <li><a href="#python-library-versions" id="toc-python-library-versions" class="nav-link" data-scroll-target="#python-library-versions"><span class="header-section-number">20.1.3</span> Python library versions</a></li>
  <li><a href="#schematic-and-circuit-description" id="toc-schematic-and-circuit-description" class="nav-link" data-scroll-target="#schematic-and-circuit-description"><span class="header-section-number">20.1.4</span> Schematic and circuit description</a></li>
  <li><a href="#symbols" id="toc-symbols" class="nav-link" data-scroll-target="#symbols"><span class="header-section-number">20.1.5</span> Symbols</a></li>
  </ul></li>
  <li><a href="#riaa-pre-emphasis-curve" id="toc-riaa-pre-emphasis-curve" class="nav-link" data-scroll-target="#riaa-pre-emphasis-curve"><span class="header-section-number">20.2</span> RIAA pre-emphasis curve</a></li>
  <li><a href="#phono-preamplifier-design-procedure" id="toc-phono-preamplifier-design-procedure" class="nav-link" data-scroll-target="#phono-preamplifier-design-procedure"><span class="header-section-number">20.3</span> Phono Preamplifier Design Procedure</a></li>
  <li><a href="#analysis-of-an-346-phono-preamplifier-circuit" id="toc-analysis-of-an-346-phono-preamplifier-circuit" class="nav-link" data-scroll-target="#analysis-of-an-346-phono-preamplifier-circuit"><span class="header-section-number">20.4</span> Analysis of AN-346 phono preamplifier circuit</a>
  <ul class="collapse">
  <li><a href="#modified-nodal-analysis" id="toc-modified-nodal-analysis" class="nav-link" data-scroll-target="#modified-nodal-analysis"><span class="header-section-number">20.4.1</span> Modified nodal analysis</a></li>
  <li><a href="#pole-zero-plot" id="toc-pole-zero-plot" class="nav-link" data-scroll-target="#pole-zero-plot"><span class="header-section-number">20.4.2</span> Pole zero plot</a></li>
  <li><a href="#stability" id="toc-stability" class="nav-link" data-scroll-target="#stability"><span class="header-section-number">20.4.3</span> Stability</a></li>
  <li><a href="#bode-plot" id="toc-bode-plot" class="nav-link" data-scroll-target="#bode-plot"><span class="header-section-number">20.4.4</span> Bode plot</a></li>
  <li><a href="#impulse-and-step-response" id="toc-impulse-and-step-response" class="nav-link" data-scroll-target="#impulse-and-step-response"><span class="header-section-number">20.4.5</span> Impulse and step response</a></li>
  <li><a href="#group-delay" id="toc-group-delay" class="nav-link" data-scroll-target="#group-delay"><span class="header-section-number">20.4.6</span> Group delay</a></li>
  <li><a href="#comparing-results-to-ltspice" id="toc-comparing-results-to-ltspice" class="nav-link" data-scroll-target="#comparing-results-to-ltspice"><span class="header-section-number">20.4.7</span> Comparing results to LTSpice</a></li>
  <li><a href="#preamplifier-deviation-from-riaa-response" id="toc-preamplifier-deviation-from-riaa-response" class="nav-link" data-scroll-target="#preamplifier-deviation-from-riaa-response"><span class="header-section-number">20.4.8</span> Preamplifier deviation from RIAA response</a></li>
  <li><a href="#sensitivity-analysis" id="toc-sensitivity-analysis" class="nav-link" data-scroll-target="#sensitivity-analysis"><span class="header-section-number">20.4.9</span> Sensitivity analysis</a></li>
  <li><a href="#component-selection" id="toc-component-selection" class="nav-link" data-scroll-target="#component-selection"><span class="header-section-number">20.4.10</span> Component selection</a></li>
  <li><a href="#monte-carlo-simulation" id="toc-monte-carlo-simulation" class="nav-link" data-scroll-target="#monte-carlo-simulation"><span class="header-section-number">20.4.11</span> Monte Carlo simulation</a></li>
  <li><a href="#preamplifier-deviation-from-riaa-response-1" id="toc-preamplifier-deviation-from-riaa-response-1" class="nav-link" data-scroll-target="#preamplifier-deviation-from-riaa-response-1"><span class="header-section-number">20.4.12</span> Preamplifier deviation from RIAA response</a></li>
  <li><a href="#worst-case-analysis" id="toc-worst-case-analysis" class="nav-link" data-scroll-target="#worst-case-analysis"><span class="header-section-number">20.4.13</span> Worst case analysis</a></li>
  </ul></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary"><span class="header-section-number">20.5</span> Summary</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./Example-problems.html">Example problems</a></li><li class="breadcrumb-item"><a href="./Two amplifier RIAA Phono Preamp.html"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Two amplifier RIAA phono preamp</span></a></li></ol></nav>
<div class="quarto-title">
<h1 class="title"><span id="sec-phono-preamp" class="quarto-section-identifier"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Two amplifier RIAA phono preamp</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="phono-stylus.png" class="img-fluid figure-img"></p>
<figcaption>Photo of a phono stylus playing a record (photo taken from Holland Koningsdam, hallway, deck 7, midship)</figcaption>
</figure>
</div>
<section id="abstract" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="abstract">Abstract</h2>
<p>This paper analyizes the circuit for the RIAA preamp given in the Texas Instruments application note AN346, <a href="https://www.ti.com/lit/an/snoa586d/snoa586d.pdf">High-Performance Audio Applications of the LM833</a>, shown in the app note as Figure 3. The schematic for the phono preamplifier was entered into <a href="https://www.analog.com/en/design-center/design-tools-and-calculators/ltspice-simulator.html">LTSpice</a> and the circuit net list was generated. A circuit analysis method called the <a href="https://en.wikipedia.org/wiki/Modified_nodal_analysis">Modified Nodal Analysis</a> was used to derive the symbolic circuit equations and Python libraries were used to solve the equations. The preamplifier transfer function was used to calculate the Bode, impuse and step response plots. The Python results were compared to those from LTSpice. Deviation from the RIAA response curve was also examined. The sensitivity, Monte Carlo and worst case analysis for the preamplifier circuit was performed. The JupyterLab notebook show cases the use of Python in electrical engineering and circuit analysis.</p>
<p><strong>Contents</strong><br>
1. Introduction<br>
2. RIAA pre-emphasis curve<br>
3. AN346 RIAA Phono Preamplifier Design Procedure<br>
4. Analysis of the phono preamplifier circuit<br>
5. Summary</p>
</section>
<section id="introduction" class="level2" data-number="20.1">
<h2 data-number="20.1" class="anchored" data-anchor-id="introduction"><span class="header-section-number">20.1</span> Introduction</h2>
<p>This <a href="https://jupyterlab.readthedocs.io/en/latest/">JupyterLab notebook</a> uses the <a href="https://www.sympy.org/">SymPy</a>, <a href="https://numpy.org/">NumPy</a>,<a href="https://scipy.org/">SciPy</a> and the <a href="https://www.python.org/">Python</a> programming language libraries to analyze a phono preamplifier circuit from the Texas Instruments application note, AN346, <a href="https://www.ti.com/lit/an/snoa586d/snoa586d.pdf">High-Performance Audio Applications of the LM833</a>. The purpose of this analysis is to demonstrate the capability of using the Python libraries in electrical engineering circuit analysis. The circuit chosen for this analysis is a two stage RIAA Phono Preamplifier described in the application note. The preamplifier is designed to accurately reproduce the RIAA equalization curve required for play back of Vinyl LP records. The preamplifier provides about 35 dB of gain at 1kHz along with the proper gain profile and phase response. The schematic of the circuit is shown below with each node explicity annotated.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Two-amplifier-RIAA-Phone-Preamp.png" class="img-fluid figure-img"></p>
<figcaption>Schematic</figcaption>
</figure>
</div>
<p>There has been a resurgence on the popularity of Vinyl LP records over the last few years. So the use of a RIAA Phono Preamplifier is still relevant in this age where most music is delivered by streaming. Two internet news stories describe the current market for Vinyl LP records:</p>
<p><a href="https://www.billboard.com/pro/album-format-dead-narrative-music-discovery-tiktok-singles/">They Said the Album Was Dying. They Were Wrong</a></p>
<blockquote class="blockquote">
<p>Vinyl sales have grown steadily for 17 years, but jumped by a stunning 46% in 2020 and 51% in 2021 …</p>
</blockquote>
<p><a href="https://www.themanual.com/culture/why-vinyl-is-coming-back/">Why Vinyl Records Are Making a Comeback in 2022</a></p>
<blockquote class="blockquote">
<p>This year, 2020, marks the first year in more than a generation since record sales — that is to say physical vinyl records — have surpassed CD sales. The reasons for this are twofold: CD sales have dropped dramatically in recent years, while sales of vinyl records are actually up this year. And while you might think it’s nostalgic Boomers or Gen Xers behind the renaissance of records, in fact surveys show it’s millennial consumers driving the rising trend in vinyl sales.</p>
</blockquote>
<blockquote class="blockquote">
<p>So vinyl is here to stay, it seems, despite all technological advances that would have seemed to threaten it. The same RIAA study that found records surpassing CDs also revealed that streaming music now account for more than 85% of all music enjoyed. Only 6% of music is now downloaded, even less than is physically purchased in the form of records, CDs, or the last tapes.</p>
</blockquote>
<p>Today there are hundreds of phono products sold on Amazon. Phono preamps range in price from $10 to $1,000 dollars.</p>
<p>The Phono Preamplifier also known as a phono stage, is an audio component that amplifies the signal from your turntable to a level that allows you to connect it to your sound system the same way you would with any other audio source. In addition to boosting the signal from the phono carterage, the preamp applies the <a href="https://en.wikipedia.org/wiki/RIAA_equalization">RIAA equalization</a> curve to the signal, reverting it back to the shape it was on the original recording. Phono cartridge output varies depending on the type of phono cartridge. Moving Magnet (MM) or Moving Iron (MI) cartridges typically produce a maximum output of 5mV. Moving Coil (MC) cartridges produce a much lower output, typically around 0.5mV maximum. Most phono preamps have switch that allow users to select the type of coil they have installed on their turn table arm.</p>
<p>Texas Instruments provided the schematic of the preamplifier in their application note to highlight the types of applications their <a href="https://www.ti.com/product/LM833#product-details">LM833</a> operational amplifier can support. Application notes are sometimes part of the marketing literature provided along with component data sheets by semiconductor manufactures.</p>
<p>RIAA equalization is a specification for the recording and playback of phonograph records, established by the Recording Industry Association of America (<a href="https://en.wikipedia.org/wiki/Recording_Industry_Association_of_America">RIAA</a>). RIAA was formed in 1952. Its original mission was to administer recording copyright fees and problems, work with trade unions, and do research relating to the record industry and government regulations. Early RIAA standards included the RIAA equalization curve, the format of the stereophonic record groove and the dimensions of 33 1/3, 45, and 78 rpm records.</p>
<p>The purposes of the equalization are to permit greater recording times (by decreasing the mean width of each groove), to improve sound quality and to reduce the groove damage that would otherwise arise during playback. RIAA equalization is a form of pre-emphasis on recording and de-emphasis on playback. A recording is made with the low frequencies reduced and the high frequencies boosted, and on playback, the opposite occurs. The net result is a flat frequency response, but with attenuation of high-frequency noise such as hiss and clicks that arise from the recording medium. Reducing the low frequencies also limits the excursions the cutter needs to make when cutting a groove. Groove width is thus reduced, allowing more grooves to fit into a given surface area, permitting longer recording times. This also reduces physical stresses on the stylus, which might otherwise cause distortion or groove damage during playback.</p>
<section id="scope" class="level3" data-number="20.1.1">
<h3 data-number="20.1.1" class="anchored" data-anchor-id="scope"><span class="header-section-number">20.1.1</span> Scope</h3>
<p>The analysis presented in this notebook is intended to illustrate the use of Python for circuit analysis. This is not a tutorial on how to design a better phono preamp. The circuit taken from the Texas Instruments application note is examined for what it is, which is a suggested application for the use of their audio grade op amp. However, in this analysis I don’t address the performance of the op amp relative to the implementation of the RIAA equalization curve. I’m more concerned with examining the circuit’s ability to reproduce the proper gain and phase over the audio band. The performance LM833 op amp is assumed to be sufficient for this application and in my analysis of the circuit, I’ve replaced the LM833 with an ideal op amp model. Also, it is assumed that the reader is familiar with electronic components such as <a href="https://en.wikipedia.org/wiki/Resistor">resistors</a>, <a href="https://en.wikipedia.org/wiki/Capacitor">capacitors</a> and <a href="https://en.wikipedia.org/wiki/Operational_amplifier">operational amplifiers</a> also known as op amps or opamps.</p>
</section>
<section id="methodology" class="level3" data-number="20.1.2">
<h3 data-number="20.1.2" class="anchored" data-anchor-id="methodology"><span class="header-section-number">20.1.2</span> Methodology</h3>
<p>The analysis presented in this notebook will cover a topics that are often presented during a design review. Ususaly during a design review conformance to requirements is presented. For the phono preamp circuit, the main performance requirement is minimum deviation from the RIAA curve. The application note from TI stated that the deviation is less than 0.1 dB over the audio band when using 1% resistors.</p>
<p>In this notebook the analysis is divided into sections.</p>
<ul>
<li>The analysis will start with an description of the circuit operation and some basic calculations.</li>
<li>There are many symbols used in the equations and these are listed in a table for reference. I also tried to be constant with variable names.</li>
<li>The RIAA pre-emphasis curve is discussed and the transfer function, pole/zero plot and amplitude and phase response is plotted.</li>
<li>Calculations for the phono preamplifier design procedure as covered in the application note are presented. The element values obtain with this procedure are the ones used in the analysis.</li>
<li>The equations for the transfer function of the preamp are derived by using a tecnhique known as modified nodal analysis.</li>
<li>The preamp poles and zeros are plotted and some comments about stability are provided.</li>
<li>The amplitude and phase responce of the preamp transfer function is plotted.</li>
<li>The impulse, step and group dealy are plotted</li>
<li>The amplitude and phase response of the preamp transfer function is plotted against results taken from LTSpice as a check and comparision.</li>
<li>The deviation of the amplitude and phase responce from the RIAA curve is plotted.</li>
<li>Sensitivity analsysis, component selection, monte carlo and worst case analysis are presented.</li>
</ul>
<div id="cell-2" class="cell" data-jupyter="{&quot;outputs_hidden&quot;:false}" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sympy <span class="im">import</span> <span class="op">*</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy <span class="im">import</span> signal</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>init_printing()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="python-library-versions" class="level3" data-number="20.1.3">
<h3 data-number="20.1.3" class="anchored" data-anchor-id="python-library-versions"><span class="header-section-number">20.1.3</span> Python library versions</h3>
<ul>
<li>python: 3.10.9</li>
<li>numpy: 1.23.5</li>
<li>sympy: 1.11.1</li>
<li>scipy: 1.10.0</li>
<li>matplotlib: 3.7.0</li>
</ul>
<p>Define a function to return the system gain at a frequency: get_gain()</p>
<div id="cell-5" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_gain(freq_Hz, sys):</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">'''</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co">    freq_Hz: the frequency in Hz for which the system gain is desired</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co">    sys: a SciPy instance of the LTI class or a tuple describing the system</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co">    '''</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    f1 <span class="op">=</span> freq_Hz <span class="op">-</span> freq_Hz<span class="op">*</span><span class="fl">0.1</span> <span class="co"># lower limit of the frequency range</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    f1a <span class="op">=</span> freq_Hz <span class="op">-</span> freq_Hz<span class="op">*</span><span class="fl">0.01</span> <span class="co"># lower interpolation point</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    f2 <span class="op">=</span> freq_Hz <span class="op">+</span> freq_Hz<span class="op">*</span><span class="fl">0.1</span> <span class="co"># upper limit of the frequency range</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    f2a <span class="op">=</span> freq_Hz <span class="op">+</span> freq_Hz<span class="op">*</span><span class="fl">0.01</span>  <span class="co"># upper interpolation point</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    x_axis_range <span class="op">=</span> np.linspace(f1<span class="op">*</span><span class="dv">2</span><span class="op">*</span>np.pi, f2<span class="op">*</span><span class="dv">2</span><span class="op">*</span>np.pi, <span class="dv">1000</span>, endpoint<span class="op">=</span><span class="va">True</span>) <span class="co"># define the range frequency range</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    w, mag, phase <span class="op">=</span> sys.bode(w<span class="op">=</span>x_axis_range)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    index_for_f1a <span class="op">=</span> np.where(w <span class="op">&gt;</span> f1a<span class="op">*</span><span class="dv">2</span><span class="op">*</span>np.pi)[<span class="dv">0</span>][<span class="dv">0</span>]</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    index_for_f2a <span class="op">=</span> np.where(w <span class="op">&gt;</span> f2a<span class="op">*</span><span class="dv">2</span><span class="op">*</span>np.pi)[<span class="dv">0</span>][<span class="dv">0</span>]</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.interp(freq_Hz, [w[index_for_f1a]<span class="op">/</span>(<span class="dv">2</span><span class="op">*</span>np.pi),w[index_for_f2a]<span class="op">/</span>(<span class="dv">2</span><span class="op">*</span>np.pi)], [mag[index_for_f1a],mag[index_for_f2a]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="schematic-and-circuit-description" class="level3" data-number="20.1.4">
<h3 data-number="20.1.4" class="anchored" data-anchor-id="schematic-and-circuit-description"><span class="header-section-number">20.1.4</span> Schematic and circuit description</h3>
<p>The circuit from Figure 3 of AN346 was entered into LTSpice and the circuit nodes were numbered as shown above. Any schematic capture program could be used to for this as long as a Spice like netlist can be generated. In the schematic, the voltage source V1, is set to 5 mV to represent the output of a Moving Magnet (MM) or Moving Iron (MI) cartridge. The input to the preamp is shunted by a capacitance, which is equal to the sum of the input cable capacitance and the cartridge. This capacitance resonates with the inductance of the moving magnet cartridge to determine the frequency response of the transducer, so when a moving magnet pickup is used, Cp should be carefully chosen so that the total capacitance is equal to the recommended load capitance for that particular cartridge. 100 pF is used in this analysis. Rp is the recommended resistive load for the phono cartridge. In some comercial preamp designs, the value of Rp is user selectable with switches. As shown in the calculations, Cp and Rp have a resonant frequency of 33.86kHz.</p>
<div id="cell-7" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>Cp <span class="op">=</span> <span class="fl">100e-12</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>Rp <span class="op">=</span> <span class="fl">47e3</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'resonant frequency: </span><span class="sc">{:,.1f}</span><span class="st"> Hz'</span>.<span class="bu">format</span>(<span class="dv">1</span><span class="op">/</span>(<span class="dv">2</span><span class="op">*</span>np.pi<span class="op">*</span>Rp<span class="op">*</span>Cp)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>resonant frequency: 33,862.8 Hz</code></pre>
</div>
</div>
<p>33,862 Hz is well above the audio range.</p>
<p>The first operational amplifier, U1, takes care of the 50 Hz and 500 Hz breakpoints. For the analysis with Python, the op amp is modeled as and ideal opamp. There is expected to be some differences between the LTSpice results and the Python analysis. Using two amplifiers results in accurate conformance to the RIAA curve without reverting to the noisy inverting topology, as well as lower distortion due to the fact that each amplifier is operating at a lower gain than would be the case in a single-amplifier design.</p>
<p>The resistor, R1, which has a value of 80.6k<span class="math inline">\(\Omega\)</span> and the capacitor C1, which has a value of 0.039 <span class="math inline">\(\mu\)</span>Farads, form a resonant pair with frequency of 50.6 Hz.</p>
<div id="cell-9" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>R1 <span class="op">=</span> <span class="fl">80.6e3</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>C1 <span class="op">=</span> <span class="fl">0.039e-6</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'resonant frequency: </span><span class="sc">{:,.1f}</span><span class="st"> Hz'</span>.<span class="bu">format</span>(<span class="dv">1</span><span class="op">/</span>(<span class="dv">2</span><span class="op">*</span>np.pi<span class="op">*</span>R1<span class="op">*</span>C1)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>resonant frequency: 50.6 Hz</code></pre>
</div>
</div>
<p>50 Hz is one of the RIAA time constants required by the RIAA specification.</p>
<p>From here on, I’ll refer to resistors that have values in 1000’s of Ohms by using k for thousands of Ohms or just the numerical value if it’s less than 1000. Capacitors will have values indicated in <span class="math inline">\(\mu\)</span> for micro Farads and p for pico Farads, designated as <span class="math inline">\(\mu\)</span> or p.&nbsp;</p>
<div id="cell-11" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>R2 <span class="op">=</span> <span class="fl">8.45e3</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'resonant frequency: </span><span class="sc">{:,.1f}</span><span class="st"> Hz'</span>.<span class="bu">format</span>(<span class="dv">1</span><span class="op">/</span>(<span class="dv">2</span><span class="op">*</span>np.pi<span class="op">*</span>R2<span class="op">*</span>C1)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>resonant frequency: 482.9 Hz</code></pre>
</div>
</div>
<p>C1 and R2, which has a value of 8.45k, have a resonant frequency of 482.94 Hz. As describe later, these frequencies correspond to the time constants required by the RIAA specification.</p>
<p>Co provides an AC ground for the non-inverting configuration of U1. Ro along with R1 and R2 set the low frequency gain of U1.</p>
<div id="cell-13" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>Ro <span class="op">=</span> <span class="dv">499</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>Co <span class="op">=</span> <span class="fl">200e-6</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'resonant frequency: </span><span class="sc">{:,.1f}</span><span class="st"> Hz'</span>.<span class="bu">format</span>(<span class="dv">1</span><span class="op">/</span>(<span class="dv">2</span><span class="op">*</span>np.pi<span class="op">*</span>Ro<span class="op">*</span>Co)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>resonant frequency: 1.6 Hz</code></pre>
</div>
</div>
<p>Ro=499 and Co=200<span class="math inline">\(\mu\)</span> have a resonant frequency of 1.6 Hz.</p>
<div id="cell-15" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>Rf<span class="op">=</span>R1<span class="op">+</span>R2</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'low frequency voltage gain of U1: </span><span class="sc">{:,.2f}</span><span class="st"> or </span><span class="sc">{:,.1f}</span><span class="st">dB'</span>.<span class="bu">format</span>(<span class="dv">1</span><span class="op">+</span>Rf<span class="op">/</span>Ro, <span class="dv">20</span><span class="op">*</span>np.log10(<span class="dv">1</span><span class="op">+</span>Rf<span class="op">/</span>Ro)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>low frequency voltage gain of U1: 179.46 or 45.1dB</code></pre>
</div>
</div>
<p>Ro along with R1 and R2 set the low frequency gain of U1 at 45 dB.</p>
<div id="cell-17" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>R3 <span class="op">=</span> <span class="fl">2.37e3</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>C3 <span class="op">=</span> <span class="fl">0.033e-6</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'resonant frequency: </span><span class="sc">{:,.1f}</span><span class="st"> Hz'</span>.<span class="bu">format</span>(<span class="dv">1</span><span class="op">/</span>(<span class="dv">2</span><span class="op">*</span>np.pi<span class="op">*</span>R3<span class="op">*</span>C3)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>resonant frequency: 2,035.0 Hz</code></pre>
</div>
</div>
<p>R3=2.37k and C3=0.033<span class="math inline">\(\mu\)</span> have a resonant frequency of 2034.96 Hz and corresponds to the the third time constant specified by RIAA.</p>
<p>C4=2<span class="math inline">\(\mu\)</span> and R6=54.9k form a high pass filter with a corner frequency of 1.45Hz.</p>
<div id="cell-19" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>R6 <span class="op">=</span> <span class="fl">54.9e3</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>C4 <span class="op">=</span> <span class="fl">2e-6</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'resonant frequency: </span><span class="sc">{:,.1f}</span><span class="st"> Hz'</span>.<span class="bu">format</span>(<span class="dv">1</span><span class="op">/</span>(<span class="dv">2</span><span class="op">*</span>np.pi<span class="op">*</span>R6<span class="op">*</span>C4)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>resonant frequency: 1.4 Hz</code></pre>
</div>
</div>
<p>U2, R4 and R5 form a non inverting configuration with a voltage gain of 3.15 or 9.98 dB.</p>
<div id="cell-21" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>R4<span class="op">=</span><span class="fl">2e3</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>R5<span class="op">=</span><span class="fl">4.3e3</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'voltage gain of U2: </span><span class="sc">{:,.2f}</span><span class="st"> or </span><span class="sc">{:,.1f}</span><span class="st">dB'</span>.<span class="bu">format</span>(<span class="dv">1</span><span class="op">+</span>R5<span class="op">/</span>R4, <span class="dv">20</span><span class="op">*</span>np.log10(<span class="dv">1</span><span class="op">+</span>R5<span class="op">/</span>R4)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>voltage gain of U2: 3.15 or 10.0dB</code></pre>
</div>
</div>
</section>
<section id="symbols" class="level3" data-number="20.1.5">
<h3 data-number="20.1.5" class="anchored" data-anchor-id="symbols"><span class="header-section-number">20.1.5</span> Symbols</h3>
<p>In this notebook the following symbols are used:</p>
<table class="table">
<colgroup>
<col style="width: 50%">
<col style="width: 50%">
</colgroup>
<thead>
<tr class="header">
<th>Symbol</th>
<th>defininition</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>s</td>
<td>when used in a polynominal: the Laplace variable equal to <span class="math inline">\(\alpha + j\omega\)</span></td>
</tr>
<tr class="even">
<td><span class="math inline">\(\mu\)</span></td>
<td><span class="math inline">\(1 \times 10^{-6}\)</span> multiplier, either: <span class="math inline">\(1 \times 10^{-6}\)</span> seconds or <span class="math inline">\(1 \times 10^{-6}\)</span> Farads</td>
</tr>
<tr class="odd">
<td>T</td>
<td>time constant: T1, T2, T3</td>
</tr>
<tr class="even">
<td><span class="math inline">\(\omega\)</span></td>
<td>angular frequency, radians per second, <span class="math inline">\(\omega = 1/T\)</span></td>
</tr>
<tr class="odd">
<td>f</td>
<td>frequency in cycles per second, <span class="math inline">\(f = \frac{\omega}{2\pi}\)</span></td>
</tr>
<tr class="even">
<td>R</td>
<td>resistor: R1, R2 etc.</td>
</tr>
<tr class="odd">
<td>C</td>
<td>capacitor: C1, C2 etc.</td>
</tr>
<tr class="even">
<td>v</td>
<td>node voltage: v1, v2, v3 etc.</td>
</tr>
<tr class="odd">
<td>V</td>
<td>voltage source, e.g.&nbsp;V1</td>
</tr>
<tr class="even">
<td>A</td>
<td>matrix describing the connectivity of the resistors, capacitors and G type (VCCS) circuit elements</td>
</tr>
<tr class="odd">
<td>X</td>
<td>vector of unknown node voltages and unknown currents</td>
</tr>
<tr class="even">
<td>Z</td>
<td>vector of known voltages and currents</td>
</tr>
<tr class="odd">
<td>RIAA_num</td>
<td>numerator of the RIAA pre-emphsis transfer function</td>
</tr>
<tr class="even">
<td>RIAA_den</td>
<td>denominator of the RIAA pre-emphsis transfer function</td>
</tr>
<tr class="odd">
<td>w_RIAA</td>
<td>radian frequncy of the RIAA pre-emphsis transfer function</td>
</tr>
<tr class="even">
<td>mag_RIAA</td>
<td>magnitude of the RIAA pre-emphsis transfer function</td>
</tr>
<tr class="odd">
<td>phase_RIAA</td>
<td>phase of the RIAA pre-emphsis transfer function</td>
</tr>
<tr class="even">
<td>RIAA_gain_1kHz</td>
<td>gain of the RIAA pre-emphsis transfer function at 1kHz</td>
</tr>
<tr class="odd">
<td>preamp_equ_sym</td>
<td>preamp circuit equations with symbolic values</td>
</tr>
<tr class="even">
<td>U_sym</td>
<td>symbolic solution to network equations, node voltages and unknown currents</td>
</tr>
<tr class="odd">
<td>H_sym</td>
<td>transfer function with symbolic coefficients</td>
</tr>
<tr class="even">
<td>preamp_equ</td>
<td>circuit equations with numeric element values</td>
</tr>
<tr class="odd">
<td>H_preamp_num</td>
<td>numerator of the transfer function</td>
</tr>
<tr class="even">
<td>H_preamp_denom</td>
<td>denominator of the transfer function</td>
</tr>
<tr class="odd">
<td>preamp_sys</td>
<td>SciPy representation of the preamp system</td>
</tr>
<tr class="even">
<td>preamp_gain_1kHz</td>
<td>gain of the preamp transfer function at 1kHz</td>
</tr>
<tr class="odd">
<td>w_preamp</td>
<td>radian frequncy of the preamp transfer function</td>
</tr>
<tr class="even">
<td>mag_preamp</td>
<td>magnitude of the preamp transfer function</td>
</tr>
<tr class="odd">
<td>phase_preamp</td>
<td>phase of the preamp transfer function</td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="riaa-pre-emphasis-curve" class="level2" data-number="20.2">
<h2 data-number="20.2" class="anchored" data-anchor-id="riaa-pre-emphasis-curve"><span class="header-section-number">20.2</span> RIAA pre-emphasis curve</h2>
<p>The RIAA equalization curve was established in 1954. The equalization is defined by time constants, T1, T2 and T3. During the <a href="https://en.wikipedia.org/wiki/Phonograph_record">Phonograph record</a> manufacturing process, a pre-emphsis is applied to the signal, which allows for longer playback times on phonograph records by decreasing the average width of the groove cut into vinyl phonograph disks. The curve attenuates low frequencies and amplifies high frequencies, relative to 1 kHz. Since low frequencies cause wide undulations in the record groove, they must be attenuated to keep the grove within its bounds. Above 1 kHz, the frequencies are amplified which helps overcome the inherent noise produced by the phonograph needle during play-back.</p>
<p>The RIAA disc recording/reproduction standard specifies the time constants of, <span class="math inline">\(T1 = 75 \mu s\)</span>, <span class="math inline">\(T2 = 318 \mu s\)</span> and <span class="math inline">\(T3 = 3180 \mu s\)</span> and the pre-emphasis transfer function:</p>
<p><span class="math inline">\(RIAA(s)=\frac {(sT_{1}+1)(sT_{3}+1)}{(sT_{2}+1)}\)</span></p>
<p>The three time constants correspond to the frequencies calculated below.</p>
<div id="cell-23" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>T1 <span class="op">=</span> <span class="fl">75e-6</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>T2 <span class="op">=</span> <span class="fl">318e-6</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>T3 <span class="op">=</span> <span class="fl">3180e-6</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'</span><span class="sc">{:.0f}</span><span class="st"> </span><span class="ch">\u03BC</span><span class="st">s corresponds to </span><span class="sc">{:,.1f}</span><span class="st"> Hz'</span>.<span class="bu">format</span>(T1<span class="op">*</span><span class="fl">1e6</span>,<span class="dv">1</span><span class="op">/</span>(T1<span class="op">*</span><span class="dv">2</span><span class="op">*</span>np.pi)))</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'</span><span class="sc">{:.0f}</span><span class="st"> </span><span class="ch">\u03BC</span><span class="st">s corresponds to </span><span class="sc">{:,.1f}</span><span class="st"> Hz'</span>.<span class="bu">format</span>(T2<span class="op">*</span><span class="fl">1e6</span>,<span class="dv">1</span><span class="op">/</span>(T2<span class="op">*</span><span class="dv">2</span><span class="op">*</span>np.pi)))</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'</span><span class="sc">{:.0f}</span><span class="st"> </span><span class="ch">\u03BC</span><span class="st">s corresponds to </span><span class="sc">{:,.1f}</span><span class="st"> Hz'</span>.<span class="bu">format</span>(T3<span class="op">*</span><span class="fl">1e6</span>,<span class="dv">1</span><span class="op">/</span>(T3<span class="op">*</span><span class="dv">2</span><span class="op">*</span>np.pi)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>75 μs corresponds to 2,122.1 Hz
318 μs corresponds to 500.5 Hz
3180 μs corresponds to 50.0 Hz</code></pre>
</div>
</div>
<p>The time constants are put in polynominal form using s as the Laplace variable. The numerator and denominator of the pre-emphasis transfer function is defined below.</p>
<div id="cell-25" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>s <span class="op">=</span> symbols(<span class="st">'s'</span>)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>RIAA_num <span class="op">=</span> Eq(((s<span class="op">*</span>T3<span class="op">+</span><span class="dv">1</span>)<span class="op">*</span>(s<span class="op">*</span>T1<span class="op">+</span><span class="dv">1</span>)),<span class="dv">0</span>)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>RIAA_denom <span class="op">=</span> Eq(s<span class="op">*</span>T2<span class="op">+</span><span class="dv">1</span>,<span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Solve for the <a href="https://en.wikipedia.org/wiki/Zeros_and_poles">poles and zeros</a> of the pre-emphasis transfer function and plot the locations on the complex s-plane. The zeros of the transfer function are the roots of the numerator polinominal. The poles of the transfer function are the roots of the denominal polinominal.</p>
<div id="cell-27" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>RIAA_zeros <span class="op">=</span> solve(RIAA_num,s)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>RIAA_poles <span class="op">=</span> solve(RIAA_denom,s)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-28" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>plt.plot(np.real(RIAA_zeros), np.imag(RIAA_zeros), <span class="st">'ob'</span>, markerfacecolor<span class="op">=</span><span class="st">'none'</span>)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>plt.plot(np.real(RIAA_poles), np.imag(RIAA_poles), <span class="st">'xr'</span>)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>plt.legend([<span class="st">'Zeros'</span>, <span class="st">'Poles'</span>], loc<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Pole / Zero Plot'</span>)</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'real part, </span><span class="ch">\u03B1</span><span class="st">'</span>)</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'imaginary part, j</span><span class="ch">\u03C9</span><span class="st">'</span>)</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>plt.grid()</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Two amplifier RIAA Phono Preamp_files/figure-html/cell-15-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-29" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'number of zeros: </span><span class="sc">{:d}</span><span class="st">'</span>.<span class="bu">format</span>(<span class="bu">len</span>(RIAA_zeros)))</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> RIAA_zeros:</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'</span><span class="sc">{:,.2f}</span><span class="st"> Hz'</span>.<span class="bu">format</span>(i<span class="op">/</span>(<span class="dv">2</span><span class="op">*</span>np.pi)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>number of zeros: 2
-2,122.07 Hz
-50.05 Hz</code></pre>
</div>
</div>
<div id="cell-30" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'number of poles: </span><span class="sc">{:d}</span><span class="st">'</span>.<span class="bu">format</span>(<span class="bu">len</span>(RIAA_poles)))</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> RIAA_poles:</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'</span><span class="sc">{:,.2f}</span><span class="st"> Hz'</span>.<span class="bu">format</span>(i<span class="op">/</span>(<span class="dv">2</span><span class="op">*</span>np.pi)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>number of poles: 1
-500.49 Hz</code></pre>
</div>
</div>
<p>As shown in the plot above, the poles and zeros lay on the negative real axis. The de-emphisis transfer function of the phono pre-amplifier should have poles at the zero locations and a zero in the pole location in the plot above.</p>
<p>The code below is used to convert SymPy symbolic equations to a numpy polynomial representation. The SciPy function, <a href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.signal.TransferFunction.html#scipy-signal-transferfunction">TransferFunction</a>, represents the system as the continuous-time transfer function. The Numpy function, <a href="https://numpy.org/doc/stable/reference/generated/numpy.logspace.html">logspace</a>, is used to generate data points on a log scale for plotting. The SciPy function, <a href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.signal.bode.html#scipy.signal.bode">bode</a>, is used to generate the magnitude and phase data of a continuous-time system.</p>
<div id="cell-32" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>a <span class="op">=</span> np.array(Poly(RIAA_num, s).all_coeffs(), dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>b <span class="op">=</span> np.array(Poly(RIAA_denom, s).all_coeffs(), dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>RIAA_sys <span class="op">=</span> signal.TransferFunction(a,b)</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>x_axis_range <span class="op">=</span> np.logspace(<span class="dv">1</span>, <span class="fl">5.5</span>, <span class="dv">100</span>, endpoint<span class="op">=</span><span class="va">True</span>)<span class="op">*</span><span class="dv">2</span><span class="op">*</span>np.pi</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>w_RIAA, mag_RIAA, phase_RIAA <span class="op">=</span> RIAA_sys.bode(w<span class="op">=</span>x_axis_range) <span class="co"># returns: rad/s, mag in dB, phase in deg</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Find the gain at 1kHz so the plots can be normalized for 0 dB at 1 kHz.</p>
<div id="cell-34" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>RIAA_gain_1kHz <span class="op">=</span> get_gain(<span class="dv">1000</span>,RIAA_sys)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-35" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'The RIAA gain at 1kHz: </span><span class="sc">{:.3f}</span><span class="st"> dB'</span>.<span class="bu">format</span>(RIAA_gain_1kHz))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>The RIAA gain at 1kHz: 19.911 dB</code></pre>
</div>
</div>
<p>Plot the magnitude and phase of the RIAA curve.</p>
<div id="cell-37" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>fig, ax1 <span class="op">=</span> plt.subplots()</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>ax1.set_ylabel(<span class="st">'magnitude, dB'</span>)</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>ax1.set_xlabel(<span class="st">'frequency, Hz'</span>)</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>plt.semilogx(w_RIAA<span class="op">/</span>(<span class="dv">2</span><span class="op">*</span>np.pi), mag_RIAA<span class="op">-</span>RIAA_gain_1kHz,<span class="st">'-k'</span>)    <span class="co"># Bode magnitude plot, normalized to 0 at 1kHz</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="co"># mark individual points</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>p3 <span class="op">=</span> np.where(w_RIAA <span class="op">&gt;</span> <span class="fl">49.9</span><span class="op">*</span>(<span class="dv">2</span><span class="op">*</span>np.pi))[<span class="dv">0</span>][<span class="dv">0</span>]</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>p2 <span class="op">=</span> np.where(w_RIAA <span class="op">&gt;</span> <span class="fl">499.9</span><span class="op">*</span>(<span class="dv">2</span><span class="op">*</span>np.pi))[<span class="dv">0</span>][<span class="dv">0</span>]</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>p1 <span class="op">=</span> np.where(w_RIAA <span class="op">&gt;</span> <span class="dv">2122</span><span class="op">*</span>(<span class="dv">2</span><span class="op">*</span>np.pi))[<span class="dv">0</span>][<span class="dv">0</span>]</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>plt.semilogx(w_RIAA[p1]<span class="op">/</span>(<span class="dv">2</span><span class="op">*</span>np.pi), mag_RIAA[p1]<span class="op">-</span>RIAA_gain_1kHz,<span class="st">'^k'</span>)</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>plt.semilogx(w_RIAA[p2]<span class="op">/</span>(<span class="dv">2</span><span class="op">*</span>np.pi), mag_RIAA[p2]<span class="op">-</span>RIAA_gain_1kHz,<span class="st">'^k'</span>)</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>plt.semilogx(w_RIAA[p3]<span class="op">/</span>(<span class="dv">2</span><span class="op">*</span>np.pi), mag_RIAA[p3]<span class="op">-</span>RIAA_gain_1kHz,<span class="st">'^k'</span>)</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>plt.text(w_RIAA[p1]<span class="op">/</span>(<span class="dv">2</span><span class="op">*</span>np.pi), mag_RIAA[p1]<span class="op">-</span><span class="dv">25</span>,<span class="st">'T1'</span>)</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>plt.text(w_RIAA[p2]<span class="op">/</span>(<span class="dv">2</span><span class="op">*</span>np.pi), mag_RIAA[p2]<span class="op">-</span><span class="dv">25</span>,<span class="st">'T2'</span>)</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>plt.text(w_RIAA[p3]<span class="op">/</span>(<span class="dv">2</span><span class="op">*</span>np.pi), mag_RIAA[p3]<span class="op">-</span><span class="dv">25</span>,<span class="st">'T3'</span>)</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a><span class="co"># hightlight the audio band, 20 to 20kHz</span></span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>plt.axvspan(<span class="dv">20</span>, <span class="fl">20e3</span>, color<span class="op">=</span><span class="st">'y'</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>ax1.tick_params(axis<span class="op">=</span><span class="st">'y'</span>)</span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>plt.grid()</span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a><span class="co"># instantiate a second y-axes that shares the same x-axis</span></span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a>ax2 <span class="op">=</span> ax1.twinx()</span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a>plt.semilogx(w_RIAA<span class="op">/</span>(<span class="dv">2</span><span class="op">*</span>np.pi), phase_RIAA,<span class="st">':'</span>,color<span class="op">=</span><span class="st">'b'</span>,label<span class="op">=</span><span class="st">'phase'</span>)  <span class="co"># Bode phase plot</span></span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a><span class="co"># mark individual points</span></span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a>plt.semilogx(w_RIAA[p1]<span class="op">/</span>(<span class="dv">2</span><span class="op">*</span>np.pi), phase_RIAA[p1],<span class="st">'xb'</span>)</span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a>plt.semilogx(w_RIAA[p2]<span class="op">/</span>(<span class="dv">2</span><span class="op">*</span>np.pi), phase_RIAA[p2],<span class="st">'xb'</span>)</span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a>plt.semilogx(w_RIAA[p3]<span class="op">/</span>(<span class="dv">2</span><span class="op">*</span>np.pi), phase_RIAA[p3],<span class="st">'xb'</span>)</span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a>ax2.set_ylabel(<span class="st">'phase, deg'</span>,color<span class="op">=</span><span class="st">'b'</span>)</span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a>ax2.tick_params(axis<span class="op">=</span><span class="st">'y'</span>, labelcolor<span class="op">=</span><span class="st">'b'</span>)</span>
<span id="cb32-37"><a href="#cb32-37" aria-hidden="true" tabindex="-1"></a>ax2.set_ylim((<span class="dv">0</span>,<span class="dv">100</span>))</span>
<span id="cb32-38"><a href="#cb32-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-39"><a href="#cb32-39" aria-hidden="true" tabindex="-1"></a>ax2.plot(np.NaN, np.NaN, color<span class="op">=</span><span class="st">'k'</span>, label<span class="op">=</span><span class="st">'magnitude'</span>)</span>
<span id="cb32-40"><a href="#cb32-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-41"><a href="#cb32-41" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb32-42"><a href="#cb32-42" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'RIAA pre-emphasis Bode plot'</span>)</span>
<span id="cb32-43"><a href="#cb32-43" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Two amplifier RIAA Phono Preamp_files/figure-html/cell-21-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>The plot above shows the frequence response of the RIAA curve. The frequencies coresponsing to the time constants T1, T2 and T3 are plotted on the magnitude and phase curves. The audio band of 20Hz to 20kHz is highlighted. One thing to notice about this curve is that the amplitdue is increasing as the frequency increases. This is not a realistic function, real circuits do not have and inifinite gain at as the frequency goes tio infinity. Also, there is no zero at <span class="math inline">\(j\omega=0\)</span>, so the pre-emphisis transfer function does not block DC.</p>
</section>
<section id="phono-preamplifier-design-procedure" class="level2" data-number="20.3">
<h2 data-number="20.3" class="anchored" data-anchor-id="phono-preamplifier-design-procedure"><span class="header-section-number">20.3</span> Phono Preamplifier Design Procedure</h2>
<p>The following notebook cells walk through the design procedure given in the application note, starting on page 5.</p>
<p>A design procedure is shown below with an illustrative example using 1% tolerance E96 components for close conformance to the ideal RIAA curve. Since 1% tolerance capacitors are often difficult to find except in 5% or 10% standard values, the design procedure calls for re-calculation of a few component values so that standard capacitor values can be used.</p>
<ol type="1">
<li><p>Choose <span class="math inline">\(R_o\)</span>. <span class="math inline">\(R_o\)</span> should be small for minimum noise contribution, but not so small that the feedback network excessively loads the amplifier. Example: Choose <span class="math inline">\(R_o = 500\)</span></p></li>
<li><p>Choose 1 kHz gain, A1 of first amplifier. This will typically be around 20 dB to 30 dB. Example: Choose A1 = 26 dB = 20</p></li>
<li><p>Calculate <span class="math inline">\(R_11 = 8.058 \times R_o \times A_1\)</span></p></li>
</ol>
<div id="cell-39" class="cell" data-execution_count="150">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>A1 <span class="op">=</span> <span class="dv">20</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>Ro <span class="op">=</span> <span class="dv">500</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>R1 <span class="op">=</span> <span class="fl">8.058</span> <span class="op">*</span> Ro <span class="op">*</span> A1</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'R1=</span><span class="sc">{:,.0f}</span><span class="st">'</span>.<span class="bu">format</span>(R1))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="4" type="1">
<li>Calculate C1</li>
</ol>
<p><span class="math inline">\(C_1 = \frac {3.18 \times 10^{-3}}{R_1}\)</span></p>
<div id="cell-41" class="cell" data-execution_count="151">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>C1 <span class="op">=</span> <span class="fl">3.18e-3</span><span class="op">/</span>R1</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'C1=</span><span class="sc">{:.4e}</span><span class="st">'</span>.<span class="bu">format</span>(C1))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>C1=3.9464e-08</code></pre>
</div>
</div>
<p>The calculated value for capacitor C1 is not a standard value, so step 5 takes care of this.</p>
<ol start="5" type="1">
<li>If C1 is not a convenient value, choose the nearest convenient value and calculate a new R1 from:</li>
</ol>
<p><span class="math inline">\(R_1 = \frac {3.18 \times 10^{-3}}{3.9 \times 10^{-8}}\)</span></p>
<p>Choose C1 to be 0.039<span class="math inline">\(\mu\)</span>, which is a standard capacitor value.</p>
<div id="cell-43" class="cell" data-execution_count="152">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>C1 <span class="op">=</span> <span class="fl">0.039e-6</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>R1 <span class="op">=</span> <span class="fl">3.18e-3</span><span class="op">/</span>C1</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'R1=</span><span class="sc">{:,.0f}</span><span class="st">'</span>.<span class="bu">format</span>(R1))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>R1=81,538</code></pre>
</div>
</div>
<p>Now choose a standard resistor value close to the the calculated value, which is 80.6k.</p>
<p>E96 resistor values are a set of perfered values for 1% resistors. When doing the calculations to determin the resistor values, the closest standandard value is chosen from the E96 series. The <a href="https://en.wikipedia.org/wiki/E_series_of_preferred_numbers">E series of preferred numbers</a> derived for use in electronic components. It consists of the E3, E6, E12, E24, E48, E96 and E192 series, where the number after the ‘E’ designates the quantity of logarithmic value “steps” per decade.</p>
<div id="cell-45" class="cell" data-execution_count="153">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>R1 <span class="op">=</span> <span class="fl">80.6e3</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Calculate a new value for Ro.</p>
<p><span class="math inline">\(R_o=\frac {R_1}{8.058A_1}\)</span></p>
<div id="cell-47" class="cell" data-execution_count="154">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>Ro <span class="op">=</span> R1<span class="op">/</span>(<span class="fl">8.058</span><span class="op">*</span>A1)</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'R1=</span><span class="sc">{:,.0f}</span><span class="st">'</span>.<span class="bu">format</span>(Ro))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>R1=500</code></pre>
</div>
</div>
<p>Choose a standard value close to this value, which is 499.</p>
<div id="cell-49" class="cell" data-execution_count="155">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>Ro <span class="op">=</span> <span class="dv">499</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="6" type="1">
<li>Caluclate R2<br>
<span class="math inline">\(R_2=\frac {R_1}{9} - R_o\)</span></li>
</ol>
<div id="cell-51" class="cell" data-execution_count="156">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>R2 <span class="op">=</span> R1<span class="op">/</span><span class="dv">9</span><span class="op">-</span>Ro</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'R1=</span><span class="sc">{:,.0f}</span><span class="st">'</span>.<span class="bu">format</span>(R2))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>R1=8,457</code></pre>
</div>
</div>
<p>Choose a standard value close to this value, which is 8.45k.</p>
<div id="cell-53" class="cell" data-execution_count="157">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>R2 <span class="op">=</span> <span class="fl">8.45e3</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="7" type="1">
<li>Choose a convenient value for C3 in the range from 0.01 <span class="math inline">\(\mu\)</span>F to 0.05 <span class="math inline">\(\mu\)</span>F.<br>
Example: C3 = 0.033 <span class="math inline">\(\mu\)</span>F</li>
</ol>
<div id="cell-55" class="cell" data-execution_count="158">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>C3 <span class="op">=</span> <span class="fl">0.033e-6</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'C3=</span><span class="sc">{:,.3f}</span><span class="ch">\u03BC</span><span class="st">'</span>.<span class="bu">format</span>(C3<span class="op">*</span><span class="fl">1e6</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>C3=0.033μ</code></pre>
</div>
</div>
<ol start="8" type="1">
<li>Calculate Rp<br>
<span class="math inline">\(R_p=\frac {75 \mu s }{C_3}\)</span></li>
</ol>
<p><span class="math inline">\(75 \mu s\)</span> is one of the RIAA time constants.</p>
<div id="cell-57" class="cell" data-execution_count="159">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>Rp <span class="op">=</span> <span class="fl">75e-6</span><span class="op">/</span>C3</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Rp=</span><span class="sc">{:,.0f}</span><span class="st">'</span>.<span class="bu">format</span>(Rp))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rp=2,273</code></pre>
</div>
</div>
<ol start="9" type="1">
<li>Choose a standard value for R3 that is slightly larger than Rp.<br>
Example: R3 = 2.37k, which is a standard resistor value.</li>
</ol>
<div id="cell-59" class="cell" data-execution_count="160">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>R3 <span class="op">=</span> <span class="fl">2.37e3</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="10" type="1">
<li>Calculate R6 from <span class="math inline">\(1/R_6 = 1/R_P − 1/R_3\)</span></li>
</ol>
<div id="cell-61" class="cell" data-execution_count="161">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>R6 <span class="op">=</span> <span class="dv">1</span><span class="op">/</span>(<span class="dv">1</span><span class="op">/</span>Rp<span class="op">-</span><span class="dv">1</span><span class="op">/</span>R3)</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'R6=</span><span class="sc">{:,.0f}</span><span class="st">'</span>.<span class="bu">format</span>(R6))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>R6=55,374</code></pre>
</div>
</div>
<p>54.9k is the closest standard value.</p>
<div id="cell-63" class="cell" data-execution_count="162">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>R6 <span class="op">=</span> <span class="fl">54.9e3</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="11" type="1">
<li>Calculate <span class="math inline">\(C_4\)</span> for low-frequency rolloff below 1 Hz from design Equation 5.</li>
</ol>
<p><span class="math inline">\(C_4=\frac{1}{2\pi f_L(R_3+R_6)}\)</span></p>
<p>Where <span class="math inline">\(f_L\)</span> is the low frequency -3dB corner of the second stage.</p>
<p>In the application note, there is a comment on page 4:<br>
&gt; If the preamplifier is to follow the IEC recommendation (IEC Publication 98, Amendment #4), fL should equal 20.2 Hz.</p>
<p>The calculations in the app note use 1 Hz.</p>
<div id="cell-65" class="cell" data-execution_count="163">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>f_L <span class="op">=</span> <span class="fl">1.0</span> <span class="co"># Hz</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>C4 <span class="op">=</span> <span class="dv">1</span><span class="op">/</span>(<span class="dv">2</span><span class="op">*</span>np.pi<span class="op">*</span>f_L<span class="op">*</span>(R3<span class="op">+</span>R6))</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'C4=</span><span class="sc">{:,.3f}</span><span class="ch">\u03BC</span><span class="st">'</span>.<span class="bu">format</span>(C4<span class="op">*</span><span class="fl">1e6</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>C4=2.779μ</code></pre>
</div>
</div>
<p>2<span class="math inline">\(\mu\)</span>F is a standard value close to the calculated value.</p>
<p>Example: C4 = 2 <span class="math inline">\(\mu\)</span>F.</p>
<ol start="12" type="1">
<li><p>Choose gain of second amplifier.<br>
Example: The 1 kHz gain up to the input of the second amplifier is about 26 dB for this example. For an overall 1 kHz gain equal to about 36 dB we choose:<br>
<span class="math inline">\(A_2 = 10 dB = 3.16\)</span></p></li>
<li><p>Choose value for R4.<br>
Example: R4 = 2k</p></li>
</ol>
<div id="cell-67" class="cell" data-execution_count="164">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>R4 <span class="op">=</span> <span class="fl">2e3</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="14" type="1">
<li>Calculate <span class="math inline">\(R_5 = (A_2 − 1) R_4\)</span></li>
</ol>
<div id="cell-69" class="cell" data-execution_count="165">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>A2 <span class="op">=</span> <span class="fl">3.16</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>R5 <span class="op">=</span> (A2<span class="op">-</span><span class="dv">1</span>)<span class="op">*</span>R4</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'R5=</span><span class="sc">{:,.0f}</span><span class="st">'</span>.<span class="bu">format</span>(R5))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>R5=4,320</code></pre>
</div>
</div>
<p>4.3k is a standard value close to the calculated value.</p>
<div id="cell-71" class="cell" data-execution_count="166">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>R5 <span class="op">=</span> <span class="fl">4.3e3</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="15" type="1">
<li>Calculate Co for low-frequency rolloff below 1 Hz from design Equation 7.</li>
</ol>
<p><span class="math inline">\(C_o=\frac {1}{2\pi f_o R_o}\)</span></p>
<p>where fo is the low-frequency −3 dB corner of the first amplifier. fo is chosen to be 1Hz for the calculations since this frequency is well below the audible frequency range.</p>
<div id="cell-73" class="cell" data-execution_count="167">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>fo <span class="op">=</span> <span class="dv">1</span> <span class="co"># 1 Hz</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>Co <span class="op">=</span> <span class="dv">1</span><span class="op">/</span>(<span class="dv">2</span><span class="op">*</span>np.pi<span class="op">*</span>fo<span class="op">*</span>Ro)</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Co=</span><span class="sc">{:,.3f}</span><span class="ch">\u03BC</span><span class="st">'</span>.<span class="bu">format</span>(Co<span class="op">*</span><span class="fl">1e6</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Co=318.948μ</code></pre>
</div>
</div>
<p>The value chosen in the app note for this component is 200<span class="math inline">\(\mu\)</span>F.</p>
<div id="cell-75" class="cell" data-execution_count="168">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>Co <span class="op">=</span> <span class="fl">200e-6</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-76" class="cell" data-execution_count="169">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'resonant frequency of Ro and Co: </span><span class="sc">{:.2f}</span><span class="st">Hz'</span>.<span class="bu">format</span>(<span class="dv">1</span><span class="op">/</span>(Co<span class="op">*</span>Ro<span class="op">*</span><span class="dv">2</span><span class="op">*</span>np.pi)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>resonant frequency of Ro and Co: 1.59Hz</code></pre>
</div>
</div>
</section>
<section id="analysis-of-an-346-phono-preamplifier-circuit" class="level2" data-number="20.4">
<h2 data-number="20.4" class="anchored" data-anchor-id="analysis-of-an-346-phono-preamplifier-circuit"><span class="header-section-number">20.4</span> Analysis of AN-346 phono preamplifier circuit</h2>
<p>The schematic of the preamp was entered into LTSpice and the netlist was generated. Starting with a schematic and then using LTSpice to generate the net list eliminates errors that would occure if these circuits were analyised by hand. For small circuits with a handful of components, symbolic solutions of the node equations can be of interest, but for larger circuits, not so much. This is because the number of symbols and equations is too large to offer in insight with out some simplicication.</p>
<p>In this section the modified nodal analysis method will be used to generate the circuit equations. The modified nodal analysis provides an algorithmic method for generating systems of independent equations for linear circuit analysis. Most problems that an electrical engineer encounters on the job are complex enough that they use computers to analyze the circuits. The Python code that generates the circuits equations is located <a href="https://github.com/Tiburonboy/Symbolic-modified-nodal-analysis">here</a>.</p>
<section id="modified-nodal-analysis" class="level3" data-number="20.4.1">
<h3 data-number="20.4.1" class="anchored" data-anchor-id="modified-nodal-analysis"><span class="header-section-number">20.4.1</span> Modified nodal analysis</h3>
<p>The preamp circuit has 15 branches, 9 nodes, 3 unknown currents, 14 passive components and 2 op amps. The net list generated by LTSpice and some edits were made to put the component values into scientific notation with units of Ohms, Farads and Henerys and the opamp statements were fixed. The edited netlist is:</p>
<pre><code>V1 1 0 5e-3m
O1 3 1 6 
O2 9 8 2 
C1 3 5 0.039e-6
Co 4 0 200e-6
Ro 3 4 499
R3 6 7 2.37e3
R1 3 5 80.6e3
R2 5 6 8.45e3
Cp 1 0 100e-12
Rp 1 0 47e3
C3 7 0 0.033e-6
C4 8 7 2e-6
R6 8 0 54.9e3
R4 9 0 2e3
R5 2 9 4.3e3</code></pre>
<p>This netlist is read into the Symbolic Modified Nodal Analysis Jupyter notebook and the following circuit equations were generated.</p>
<p><span class="math inline">\(I_{V1} + v_{1} \left(Cp s + \frac{1}{R_{20}}\right) = 0\)</span><br>
<span class="math inline">\(v_{2} \left(C_{1} s + \frac{1}{Ro} + \frac{1}{R_{1}}\right) + v_{4} \left(- C_{1} s - \frac{1}{R_{1}}\right) - \frac{v_{3}}{Ro} = 0\)</span><br>
<span class="math inline">\(v_{3} \left(Co s + \frac{1}{Ro}\right) - \frac{v_{2}}{Ro} = 0\)</span><br>
<span class="math inline">\(v_{2} \left(- C_{1} s - \frac{1}{R_{1}}\right) + v_{4} \left(C_{1} s + \frac{1}{R_{2}} + \frac{1}{R_{1}}\right) - \frac{v_{5}}{R_{2}} = 0\)</span><br>
<span class="math inline">\(I_{O1} + v_{5} \cdot \left(\frac{1}{R_{3}} + \frac{1}{R_{2}}\right) - \frac{v_{6}}{R_{3}} - \frac{v_{4}}{R_{2}} = 0\)</span><br>
<span class="math inline">\(- C_{4} s v_{7} + v_{6} \left(C_{3} s + C_{4} s + \frac{1}{R_{3}}\right) - \frac{v_{5}}{R_{3}} = 0\)</span><br>
<span class="math inline">\(- C_{4} s v_{6} + v_{7} \left(C_{4} s + \frac{1}{R_{6}}\right) = 0\)</span><br>
<span class="math inline">\(v_{8} \cdot \left(\frac{1}{R_{5}} + \frac{1}{R_{4}}\right) - \frac{v_{9}}{R_{5}} = 0\)</span><br>
<span class="math inline">\(I_{O2} + v_{9} \cdot \left(\frac{1}{R_{5}} + \frac{1}{R_{22}}\right) - \frac{v_{8}}{R_{5}} = 0\)</span><br>
<span class="math inline">\(v_{1} = V_{1}\)</span><br>
<span class="math inline">\(- v_{1} + v_{2} = 0\)</span><br>
<span class="math inline">\(- v_{7} + v_{8} = 0\)</span></p>
<p>The symbols and matrices generated by the modified nodal analysis code are copied here so that the circuit equations can be solved symbilically and later numerically. All the symboles that SymPy needs defined are delared. The A matrix describs the connectivity of the resistors, capacitors and G type (VCCS) circuit elements. The X matrix contains the unknown node voltages and unknown currents. The Z matrix contains the known voltages and currents sources, e.g.&nbsp;V1.</p>
<div id="cell-79" class="cell" data-tags="[]" data-execution_count="41">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>Rp, v6, Co, C4, v2, C3, s, I_V1, R6, Ro, R4, C1, R3, I_O2, R5, v3, I_O1, v4, v8, v7, V1, Cp, v1, R1, R2, v5, v9 <span class="op">=</span> symbols(<span class="st">' Rp  v6  Co  C4  v2  C3  s  I_V1  R6  Ro  R4  C1  R3  I_O2  R5  v3  I_O1  v4  v8  v7  V1  Cp  v1  R1  R2  v5  v9 '</span>)</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>A <span class="op">=</span> Matrix([[Cp<span class="op">*</span>s <span class="op">+</span> <span class="dv">1</span><span class="op">/</span>Rp, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>], [<span class="dv">0</span>, <span class="dv">1</span><span class="op">/</span>R5, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="op">-</span><span class="dv">1</span><span class="op">/</span>R5, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>], [<span class="dv">0</span>, <span class="dv">0</span>, C1<span class="op">*</span>s <span class="op">+</span> <span class="dv">1</span><span class="op">/</span>Ro <span class="op">+</span> <span class="dv">1</span><span class="op">/</span>R1, <span class="op">-</span><span class="dv">1</span><span class="op">/</span>Ro, <span class="op">-</span>C1<span class="op">*</span>s <span class="op">-</span> <span class="dv">1</span><span class="op">/</span>R1, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>], [<span class="dv">0</span>, <span class="dv">0</span>, <span class="op">-</span><span class="dv">1</span><span class="op">/</span>Ro, Co<span class="op">*</span>s <span class="op">+</span> <span class="dv">1</span><span class="op">/</span>Ro, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>], [<span class="dv">0</span>, <span class="dv">0</span>, <span class="op">-</span>C1<span class="op">*</span>s <span class="op">-</span> <span class="dv">1</span><span class="op">/</span>R1, <span class="dv">0</span>, C1<span class="op">*</span>s <span class="op">+</span> <span class="dv">1</span><span class="op">/</span>R2 <span class="op">+</span> <span class="dv">1</span><span class="op">/</span>R1, <span class="op">-</span><span class="dv">1</span><span class="op">/</span>R2, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>], [<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="op">-</span><span class="dv">1</span><span class="op">/</span>R2, <span class="dv">1</span><span class="op">/</span>R3 <span class="op">+</span> <span class="dv">1</span><span class="op">/</span>R2, <span class="op">-</span><span class="dv">1</span><span class="op">/</span>R3, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>], [<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="op">-</span><span class="dv">1</span><span class="op">/</span>R3, C3<span class="op">*</span>s <span class="op">+</span> C4<span class="op">*</span>s <span class="op">+</span> <span class="dv">1</span><span class="op">/</span>R3, <span class="op">-</span>C4<span class="op">*</span>s, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>], [<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="op">-</span>C4<span class="op">*</span>s, C4<span class="op">*</span>s <span class="op">+</span> <span class="dv">1</span><span class="op">/</span>R6, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>], [<span class="dv">0</span>, <span class="op">-</span><span class="dv">1</span><span class="op">/</span>R5, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span><span class="op">/</span>R5 <span class="op">+</span> <span class="dv">1</span><span class="op">/</span>R4, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>], [<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>], [<span class="op">-</span><span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>], [<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>]])</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> Matrix( [v1, v2, v3, v4, v5, v6, v7, v8, v9, I_V1, I_O1, I_O2] )</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>Z <span class="op">=</span> Matrix( [<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, V1, <span class="dv">0</span>, <span class="dv">0</span>] )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The equations are displayed in maxtrix form below.</p>
<div id="cell-81" class="cell" data-tags="[]" data-execution_count="42">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>preamp_equ_sym <span class="op">=</span> Eq(A<span class="op">*</span>X,Z)</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>preamp_equ_sym</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display cell-output-markdown" data-execution_count="42">
<p><span class="math inline">\(\displaystyle \left[\begin{matrix}I_{V1} + v_{1} \left(Cp s + \frac{1}{Rp}\right)\\I_{O2} + \frac{v_{2}}{R_{5}} - \frac{v_{9}}{R_{5}}\\v_{3} \left(C_{1} s + \frac{1}{Ro} + \frac{1}{R_{1}}\right) + v_{5} \left(- C_{1} s - \frac{1}{R_{1}}\right) - \frac{v_{4}}{Ro}\\v_{4} \left(Co s + \frac{1}{Ro}\right) - \frac{v_{3}}{Ro}\\v_{3} \left(- C_{1} s - \frac{1}{R_{1}}\right) + v_{5} \left(C_{1} s + \frac{1}{R_{2}} + \frac{1}{R_{1}}\right) - \frac{v_{6}}{R_{2}}\\I_{O1} + v_{6} \cdot \left(\frac{1}{R_{3}} + \frac{1}{R_{2}}\right) - \frac{v_{7}}{R_{3}} - \frac{v_{5}}{R_{2}}\\- C_{4} s v_{8} + v_{7} \left(C_{3} s + C_{4} s + \frac{1}{R_{3}}\right) - \frac{v_{6}}{R_{3}}\\- C_{4} s v_{7} + v_{8} \left(C_{4} s + \frac{1}{R_{6}}\right)\\v_{9} \cdot \left(\frac{1}{R_{5}} + \frac{1}{R_{4}}\right) - \frac{v_{2}}{R_{5}}\\v_{1}\\- v_{1} + v_{3}\\- v_{8} + v_{9}\end{matrix}\right] = \left[\begin{matrix}0\\0\\0\\0\\0\\0\\0\\0\\0\\V_{1}\\0\\0\end{matrix}\right]\)</span></p>
</div>
</div>
<p>These equations can be solved in thier symbolic form using the solve function from SymPy. The solution time takes about 3 seconds on my i3 laptop.</p>
<div id="cell-83" class="cell" data-execution_count="43">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>U_preamp_sym <span class="op">=</span> solve(preamp_equ_sym,X)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The transfer function for the preamp is the equation for the output node, 2, divided by the equation for the input node 1.</p>
<div id="cell-85" class="cell" data-execution_count="136">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>H_preamp_sym <span class="op">=</span> U_preamp_sym[v2]<span class="op">/</span>U_preamp_sym[v1]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The symbolic solution obtained by SymPy, while not being very interesting since they are unweildly, they illustrate the power of SymPy to easily obtain symbolic solutions that would be very difficult to obtain by hand.</p>
<div id="cell-87" class="cell" data-execution_count="137">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>H_preamp_sym</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display cell-output-markdown" data-execution_count="137">
<p><span class="math inline">\(\displaystyle \frac{C_{1} C_{4} Co R_{1} R_{2} R_{4} R_{6} V_{1} s^{3} + C_{1} C_{4} Co R_{1} R_{2} R_{5} R_{6} V_{1} s^{3} + C_{1} C_{4} Co R_{1} R_{4} R_{6} Ro V_{1} s^{3} + C_{1} C_{4} Co R_{1} R_{5} R_{6} Ro V_{1} s^{3} + C_{1} C_{4} R_{1} R_{4} R_{6} V_{1} s^{2} + C_{1} C_{4} R_{1} R_{5} R_{6} V_{1} s^{2} + C_{4} Co R_{1} R_{4} R_{6} V_{1} s^{2} + C_{4} Co R_{1} R_{5} R_{6} V_{1} s^{2} + C_{4} Co R_{2} R_{4} R_{6} V_{1} s^{2} + C_{4} Co R_{2} R_{5} R_{6} V_{1} s^{2} + C_{4} Co R_{4} R_{6} Ro V_{1} s^{2} + C_{4} Co R_{5} R_{6} Ro V_{1} s^{2} + C_{4} R_{4} R_{6} V_{1} s + C_{4} R_{5} R_{6} V_{1} s}{V_{1} \left(C_{1} C_{3} C_{4} Co R_{1} R_{3} R_{4} R_{6} Ro s^{4} + C_{1} C_{3} C_{4} R_{1} R_{3} R_{4} R_{6} s^{3} + C_{1} C_{3} Co R_{1} R_{3} R_{4} Ro s^{3} + C_{1} C_{3} R_{1} R_{3} R_{4} s^{2} + C_{1} C_{4} Co R_{1} R_{3} R_{4} Ro s^{3} + C_{1} C_{4} Co R_{1} R_{4} R_{6} Ro s^{3} + C_{1} C_{4} R_{1} R_{3} R_{4} s^{2} + C_{1} C_{4} R_{1} R_{4} R_{6} s^{2} + C_{1} Co R_{1} R_{4} Ro s^{2} + C_{1} R_{1} R_{4} s + C_{3} C_{4} Co R_{3} R_{4} R_{6} Ro s^{3} + C_{3} C_{4} R_{3} R_{4} R_{6} s^{2} + C_{3} Co R_{3} R_{4} Ro s^{2} + C_{3} R_{3} R_{4} s + C_{4} Co R_{3} R_{4} Ro s^{2} + C_{4} Co R_{4} R_{6} Ro s^{2} + C_{4} R_{3} R_{4} s + C_{4} R_{4} R_{6} s + Co R_{4} Ro s + R_{4}\right)}\)</span></p>
</div>
</div>
<p>The SymPy function, cancel(), can be used to put the preamp transfunction in to standard canonical form, where the polynomials are expanded with no common factors and the leading coefficients do not have denominators (i.e., are integers).</p>
<div id="cell-89" class="cell" data-execution_count="138">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>cancel(H_preamp_sym,s)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display cell-output-markdown" data-execution_count="138">
<p><span class="math inline">\(\displaystyle \frac{s^{3} \left(C_{1} C_{4} Co R_{1} R_{2} R_{4} R_{6} + C_{1} C_{4} Co R_{1} R_{2} R_{5} R_{6} + C_{1} C_{4} Co R_{1} R_{4} R_{6} Ro + C_{1} C_{4} Co R_{1} R_{5} R_{6} Ro\right) + s^{2} \left(C_{1} C_{4} R_{1} R_{4} R_{6} + C_{1} C_{4} R_{1} R_{5} R_{6} + C_{4} Co R_{1} R_{4} R_{6} + C_{4} Co R_{1} R_{5} R_{6} + C_{4} Co R_{2} R_{4} R_{6} + C_{4} Co R_{2} R_{5} R_{6} + C_{4} Co R_{4} R_{6} Ro + C_{4} Co R_{5} R_{6} Ro\right) + s \left(C_{4} R_{4} R_{6} + C_{4} R_{5} R_{6}\right)}{C_{1} C_{3} C_{4} Co R_{1} R_{3} R_{4} R_{6} Ro s^{4} + R_{4} + s^{3} \left(C_{1} C_{3} C_{4} R_{1} R_{3} R_{4} R_{6} + C_{1} C_{3} Co R_{1} R_{3} R_{4} Ro + C_{1} C_{4} Co R_{1} R_{3} R_{4} Ro + C_{1} C_{4} Co R_{1} R_{4} R_{6} Ro + C_{3} C_{4} Co R_{3} R_{4} R_{6} Ro\right) + s^{2} \left(C_{1} C_{3} R_{1} R_{3} R_{4} + C_{1} C_{4} R_{1} R_{3} R_{4} + C_{1} C_{4} R_{1} R_{4} R_{6} + C_{1} Co R_{1} R_{4} Ro + C_{3} C_{4} R_{3} R_{4} R_{6} + C_{3} Co R_{3} R_{4} Ro + C_{4} Co R_{3} R_{4} Ro + C_{4} Co R_{4} R_{6} Ro\right) + s \left(C_{1} R_{1} R_{4} + C_{3} R_{3} R_{4} + C_{4} R_{3} R_{4} + C_{4} R_{4} R_{6} + Co R_{4} Ro\right)}\)</span></p>
</div>
</div>
<p>The Sympy function, factor(), can be used to factor the polynominals it into irreducible factors over the rational numbers.</p>
<div id="cell-91" class="cell" data-execution_count="139">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>H_preamp_sym.factor()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display cell-output-markdown" data-execution_count="139">
<p><span class="math inline">\(\displaystyle \frac{C_{4} R_{6} s \left(R_{4} + R_{5}\right) \left(C_{1} Co R_{1} R_{2} s^{2} + C_{1} Co R_{1} Ro s^{2} + C_{1} R_{1} s + Co R_{1} s + Co R_{2} s + Co Ro s + 1\right)}{R_{4} \left(C_{1} R_{1} s + 1\right) \left(Co Ro s + 1\right) \left(C_{3} C_{4} R_{3} R_{6} s^{2} + C_{3} R_{3} s + C_{4} R_{3} s + C_{4} R_{6} s + 1\right)}\)</span></p>
</div>
</div>
<p>The symbolic solutions obtained above will be used later when the sinsitivity analysis of the preamp is performed. Otherwise the roots in symbolic form don’t seem to be particulary insightful, but are easily obtained by SymPy.</p>
<section id="numerical-solution" class="level4" data-number="20.4.1.1">
<h4 data-number="20.4.1.1" class="anchored" data-anchor-id="numerical-solution"><span class="header-section-number">20.4.1.1</span> Numerical solution</h4>
<p>The element values are put into the Python dictionary format so that numerical values can be substituted into the equations.</p>
<div id="cell-93" class="cell" data-jupyter="{&quot;outputs_hidden&quot;:false}" data-execution_count="140">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>nominal_component_value <span class="op">=</span> {V1:<span class="fl">5.0000e-03</span>, C1:<span class="fl">3.9000e-08</span>, Co:<span class="fl">2.0000e-04</span>, Ro:<span class="fl">4.9900e+02</span>, R3:<span class="fl">2.3700e+03</span>, R1:<span class="fl">8.0600e+04</span>, </span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>    R2:<span class="fl">8.4500e+03</span>, Cp:<span class="fl">1.0000e-10</span>, Rp:<span class="fl">4.7000e+04</span>, C3:<span class="fl">3.3000e-08</span>, C4:<span class="fl">2.0000e-06</span>, R6:<span class="fl">5.4900e+04</span>, R4:<span class="fl">2.0000e+03</span>, R5:<span class="fl">4.3000e+03</span>}</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a><span class="co"># put the element values into the equations</span></span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>preamp_equ <span class="op">=</span> preamp_equ_sym.subs(nominal_component_value)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we can diplay the network equations with values for the components instear of symbols.</p>
<div id="cell-95" class="cell" data-jupyter="{&quot;outputs_hidden&quot;:false}" data-execution_count="141">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>preamp_equ</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display cell-output-markdown" data-execution_count="141">
<p><span class="math inline">\(\displaystyle \left[\begin{matrix}I_{V1} + v_{1} \cdot \left(1.0 \cdot 10^{-10} s + 2.12765957446809 \cdot 10^{-5}\right)\\I_{O2} + 0.000232558139534884 v_{2} - 0.000232558139534884 v_{9}\\v_{3} \cdot \left(3.9 \cdot 10^{-8} s + 0.00201641496392288\right) - 0.00200400801603206 v_{4} + v_{5} \left(- 3.9 \cdot 10^{-8} s - 1.24069478908189 \cdot 10^{-5}\right)\\- 0.00200400801603206 v_{3} + v_{4} \cdot \left(0.0002 s + 0.00200400801603206\right)\\v_{3} \left(- 3.9 \cdot 10^{-8} s - 1.24069478908189 \cdot 10^{-5}\right) + v_{5} \cdot \left(3.9 \cdot 10^{-8} s + 0.000130750143157091\right) - 0.000118343195266272 v_{6}\\I_{O1} - 0.000118343195266272 v_{5} + 0.000540284123536314 v_{6} - 0.000421940928270042 v_{7}\\- 2.0 \cdot 10^{-6} s v_{8} - 0.000421940928270042 v_{6} + v_{7} \cdot \left(2.033 \cdot 10^{-6} s + 0.000421940928270042\right)\\- 2.0 \cdot 10^{-6} s v_{7} + v_{8} \cdot \left(2.0 \cdot 10^{-6} s + 1.82149362477231 \cdot 10^{-5}\right)\\- 0.000232558139534884 v_{2} + 0.000732558139534884 v_{9}\\v_{1}\\- v_{1} + v_{3}\\- v_{8} + v_{9}\end{matrix}\right] = \left[\begin{matrix}0\\0\\0\\0\\0\\0\\0\\0\\0\\0.005\\0\\0\end{matrix}\right]\)</span></p>
</div>
</div>
<p>Using the SymPy solve function we can solve the system of equations.</p>
<div id="cell-97" class="cell" data-jupyter="{&quot;outputs_hidden&quot;:false}" data-execution_count="142">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>U_preamp <span class="op">=</span> solve(preamp_equ,X)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The values of the exponents are very large in the solution. The numerator and denominator for v2 could be normalized. Another option for avoiding large exponents is to 1st normalize the component values by frequency scaling. I suppose that large exponents don’t become a problem as long as they remain under two digits.</p>
<p>Almost all platforms map Python floats to the IEEE754 double precision - 64 total bits. The float information using the sys package can be as shown as follows:</p>
<div id="cell-100" class="cell" data-execution_count="143">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>sys.float_info</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="143">
<pre><code>sys.float_info(max=1.7976931348623157e+308, max_exp=1024, max_10_exp=308, min=2.2250738585072014e-308, min_exp=-1021, min_10_exp=-307, dig=15, mant_dig=53, epsilon=2.220446049250313e-16, radix=2, rounds=1)</code></pre>
</div>
</div>
<div id="cell-101" class="cell" data-execution_count="144">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(sys.float_info)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>sys.float_info(max=1.7976931348623157e+308, max_exp=1024, max_10_exp=308, min=2.2250738585072014e-308, min_exp=-1021, min_10_exp=-307, dig=15, mant_dig=53, epsilon=2.220446049250313e-16, radix=2, rounds=1)</code></pre>
</div>
</div>
<p>The maximum exponent that Python can use is 308.</p>
<p>Letting SciPy do the math and not worrying about the size of the exponents. The transfer function can be obtained by divideing the equation for node 2 by the equation for node 1. The system transfer function, is <span class="math inline">\(H(s) = \frac {v2}{V1}\)</span></p>
<div id="cell-103" class="cell" data-jupyter="{&quot;outputs_hidden&quot;:false}" data-execution_count="145">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>H_preamp <span class="op">=</span> U_preamp[v2]<span class="op">/</span>U_preamp[v1]</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>H_preamp</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display cell-output-markdown" data-execution_count="145">
<p><span class="math inline">\(\displaystyle \frac{200.0 \cdot \left(2.76499422921242 \cdot 10^{69} s^{3} + 8.80353368479522 \cdot 10^{72} s^{2} + 4.91462150480132 \cdot 10^{71} s\right)}{7.65600122987477 \cdot 10^{65} s^{4} + 1.0469819689888 \cdot 10^{70} s^{3} + 3.44479259637884 \cdot 10^{72} s^{2} + 6.18286042227129 \cdot 10^{73} s + 2.84188944100537 \cdot 10^{74}}\)</span></p>
</div>
</div>
<p>factor() takes a polynomial and factors it into irreducible factors over the rational numbers. For example:</p>
<div id="cell-105" class="cell" data-execution_count="148">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>H_preamp.factor()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display cell-output-markdown" data-execution_count="148">
<p><span class="math inline">\(\displaystyle \frac{6.19554973375798 s \left(0.000314077770155853 s^{2} + 1.0 s + 0.0558255546098434\right)}{2.69398278462456 \cdot 10^{-9} s^{4} + 3.68410520790143 \cdot 10^{-5} s^{3} + 0.012121487017314 s^{2} + 0.21756161 s + 1.0}\)</span></p>
</div>
</div>
</section>
<section id="convert-transfer-function-to-scipy-system" class="level4" data-number="20.4.1.2">
<h4 data-number="20.4.1.2" class="anchored" data-anchor-id="convert-transfer-function-to-scipy-system"><span class="header-section-number">20.4.1.2</span> Convert transfer function to SciPy system</h4>
<p>In this section we convert the SymPy equations into Numpy format.</p>
<p>Extract the numerator and denominator polynomials so that the system can be defined in SciPy.</p>
<div id="cell-107" class="cell" data-tags="[]" data-execution_count="57">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>H_preamp_num, H_preamp_denom <span class="op">=</span> fraction(H_preamp) <span class="co">#returns numerator and denominator</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The SciPy function, TransferFunction, represents the system as the continuous-time transfer function and takes as inputs the coeeficients of the numerator and denominator polynominals.</p>
<div id="cell-109" class="cell" data-jupyter="{&quot;outputs_hidden&quot;:false}" data-execution_count="58">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="co"># convert symbolic to numpy polynomial</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>a2 <span class="op">=</span> np.array(Poly(H_preamp_num, s).all_coeffs(), dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>b2 <span class="op">=</span> np.array(Poly(H_preamp_denom, s).all_coeffs(), dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>preamp_sys <span class="op">=</span> signal.TransferFunction(a2,b2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The poles and zeros of the transfer function can easly be obtained with the following code:</p>
<div id="cell-111" class="cell" data-execution_count="59">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>preamp_sys_zeros <span class="op">=</span> np.roots(preamp_sys.num)</span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>preamp_sys_poles <span class="op">=</span> np.roots(preamp_sys.den)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="pole-zero-plot" class="level3" data-number="20.4.2">
<h3 data-number="20.4.2" class="anchored" data-anchor-id="pole-zero-plot"><span class="header-section-number">20.4.2</span> Pole zero plot</h3>
<p>The poles and zeros of the preamp transfer function are plotted.</p>
<div id="cell-113" class="cell" data-execution_count="60">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>plt.plot(np.real(preamp_sys_zeros), np.imag(preamp_sys_zeros), <span class="st">'ob'</span>, markerfacecolor<span class="op">=</span><span class="st">'none'</span>)</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>plt.plot(np.real(preamp_sys_poles), np.imag(preamp_sys_poles), <span class="st">'xr'</span>)</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>plt.legend([<span class="st">'Zeros'</span>, <span class="st">'Poles'</span>], loc<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Pole / Zero Plot'</span>)</span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'real part, </span><span class="ch">\u03B1</span><span class="st">'</span>)</span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'imaginary part, j</span><span class="ch">\u03C9</span><span class="st">'</span>)</span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a>plt.grid()</span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Two amplifier RIAA Phono Preamp_files/figure-html/cell-60-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Poles and zeros of the transfer function plotted on the complex plane. The units are in radian frequency.</p>
<p>Printing these values in Hz.</p>
<div id="cell-115" class="cell" data-execution_count="61">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'number of zeros: </span><span class="sc">{:d}</span><span class="st">'</span>.<span class="bu">format</span>(<span class="bu">len</span>(preamp_sys_zeros)))</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> preamp_sys_zeros:</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'</span><span class="sc">{:,.2f}</span><span class="st"> Hz'</span>.<span class="bu">format</span>(i<span class="op">/</span>(<span class="dv">2</span><span class="op">*</span>np.pi)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>number of zeros: 3
-506.73 Hz
-0.01 Hz
0.00 Hz</code></pre>
</div>
</div>
<div id="cell-116" class="cell" data-execution_count="62">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'number of poles: </span><span class="sc">{:d}</span><span class="st">'</span>.<span class="bu">format</span>(<span class="bu">len</span>(preamp_sys_poles)))</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> preamp_sys_poles:</span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'</span><span class="sc">{:,.2f}</span><span class="st"> Hz'</span>.<span class="bu">format</span>(i<span class="op">/</span>(<span class="dv">2</span><span class="op">*</span>np.pi)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>number of poles: 4
-2,122.88 Hz
-50.63 Hz
-1.59 Hz
-1.39 Hz</code></pre>
</div>
</div>
<p>We can see that the RIAA time constants, displayed in terms of frequency are present, althought the values diffeer by a few Hz. There are two zeros and two poles at nearly zero hz and these cancel each other.</p>
</section>
<section id="stability" class="level3" data-number="20.4.3">
<h3 data-number="20.4.3" class="anchored" data-anchor-id="stability"><span class="header-section-number">20.4.3</span> Stability</h3>
<p>By inspecting the plot above, we can tell the preamplifier is stable since the phase shift at 0 dB of gain is less than 180 degrees. Additionally, all the poles of the transfer function are in the left hand plane.</p>
<p>Now we can find the preamp gain at 1 kHz, so that the bode plots can be normailized.</p>
<div id="cell-118" class="cell" data-execution_count="63">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>preamp_gain_1kHz <span class="op">=</span> get_gain(<span class="dv">1000</span>, preamp_sys)</span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'preamp gain at 1kHz: </span><span class="sc">{:f}</span><span class="st"> dB'</span>.<span class="bu">format</span>(preamp_gain_1kHz))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>preamp gain at 1kHz: 34.783614 dB</code></pre>
</div>
</div>
</section>
<section id="bode-plot" class="level3" data-number="20.4.4">
<h3 data-number="20.4.4" class="anchored" data-anchor-id="bode-plot"><span class="header-section-number">20.4.4</span> Bode plot</h3>
<p>Use the SciPy function <a href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.signal.bode.html">bode</a> to plot the magnitude and phase of the filter. In electrical engineering, a <a href="https://en.wikipedia.org/wiki/Bode_plot">Bode plot</a> is a graph of the frequency response of a system. It is usually a combination of the magnitude (usually in decibels) of the frequency response and the phase shift. As originally conceived by Hendrik Wade Bode in the 1930s, the plot is an asymptotic approximation of the frequency response, using straight line segments. Bode plots are used to assess the stability of systems by finding the gain and phase margins.</p>
<div id="cell-120" class="cell" data-execution_count="64">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>extended_x_axis_range <span class="op">=</span> np.logspace(<span class="op">-</span><span class="dv">2</span>, <span class="dv">8</span>, <span class="dv">5000</span>, endpoint<span class="op">=</span><span class="va">True</span>)<span class="op">*</span><span class="dv">2</span><span class="op">*</span>np.pi</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>w_preamp, mag_preamp, phase_preamp <span class="op">=</span> preamp_sys.bode(w<span class="op">=</span>extended_x_axis_range)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-121" class="cell" data-execution_count="65">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>fig, ax1 <span class="op">=</span> plt.subplots()</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>ax1.set_ylabel(<span class="st">'magnitude, dB'</span>)</span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>ax1.set_xlabel(<span class="st">'frequency, Hz'</span>)</span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a>plt.semilogx(w_preamp<span class="op">/</span>(<span class="dv">2</span><span class="op">*</span>np.pi), mag_preamp,<span class="st">'-k'</span>)    <span class="co"># Bode magnitude plot</span></span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a>ax1.tick_params(axis<span class="op">=</span><span class="st">'y'</span>)</span>
<span id="cb92-8"><a href="#cb92-8" aria-hidden="true" tabindex="-1"></a>plt.grid()</span>
<span id="cb92-9"><a href="#cb92-9" aria-hidden="true" tabindex="-1"></a>plt.axvspan(<span class="dv">20</span>, <span class="fl">20e3</span>, color<span class="op">=</span><span class="st">'y'</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb92-10"><a href="#cb92-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-11"><a href="#cb92-11" aria-hidden="true" tabindex="-1"></a><span class="co"># instantiate a second y-axes that shares the same x-axis</span></span>
<span id="cb92-12"><a href="#cb92-12" aria-hidden="true" tabindex="-1"></a>ax2 <span class="op">=</span> ax1.twinx()</span>
<span id="cb92-13"><a href="#cb92-13" aria-hidden="true" tabindex="-1"></a>color <span class="op">=</span> <span class="st">'b'</span> <span class="co">#'tab:blue'</span></span>
<span id="cb92-14"><a href="#cb92-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-15"><a href="#cb92-15" aria-hidden="true" tabindex="-1"></a>plt.semilogx(w_preamp<span class="op">/</span>(<span class="dv">2</span><span class="op">*</span>np.pi), phase_preamp,<span class="st">':'</span>,color<span class="op">=</span>color,label<span class="op">=</span><span class="st">'phase'</span>)  <span class="co"># Bode phase plot</span></span>
<span id="cb92-16"><a href="#cb92-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-17"><a href="#cb92-17" aria-hidden="true" tabindex="-1"></a>ax2.set_ylabel(<span class="st">'phase, deg'</span>,color<span class="op">=</span>color)</span>
<span id="cb92-18"><a href="#cb92-18" aria-hidden="true" tabindex="-1"></a>ax2.tick_params(axis<span class="op">=</span><span class="st">'y'</span>, labelcolor<span class="op">=</span>color)</span>
<span id="cb92-19"><a href="#cb92-19" aria-hidden="true" tabindex="-1"></a>ax2.plot(np.NaN, np.NaN, <span class="st">'-'</span>, color<span class="op">=</span><span class="st">'k'</span>, label<span class="op">=</span><span class="st">'magnitude'</span>)</span>
<span id="cb92-20"><a href="#cb92-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-21"><a href="#cb92-21" aria-hidden="true" tabindex="-1"></a>plt.legend(loc<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb92-22"><a href="#cb92-22" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'preamplifier Bode plot'</span>)</span>
<span id="cb92-23"><a href="#cb92-23" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Two amplifier RIAA Phono Preamp_files/figure-html/cell-65-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>The Bode plot for the preamplifier is plotted from 0.01 Hz to 100 MHz. The preamplifier circuit blocks DC because C4 in in series with the audio path.</p>
</section>
<section id="impulse-and-step-response" class="level3" data-number="20.4.5">
<h3 data-number="20.4.5" class="anchored" data-anchor-id="impulse-and-step-response"><span class="header-section-number">20.4.5</span> Impulse and step response</h3>
<p>Use the SciPy functions <a href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.signal.impulse2.html">impulse2</a> and <a href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.signal.step2.html">step2</a> to plot the impulse and step response of the system.</p>
<p>The <a href="https://en.wikipedia.org/wiki/Impulse_response">impulse</a> and <a href="https://en.wikipedia.org/wiki/Step_response">step response</a> of the filter are plotted below. Any linear, time-invariant is completely characterized by its impulse response. The transfer function is the Laplace transform of the impulse response. The impulse response defines the response of a linear time-invariant system for all frequencies.</p>
<p>In electronic engineering and control theory, step response is the time behavior of the outputs of a general system when its inputs change from zero to one in a very short time.</p>
<div id="cell-123" class="cell" data-execution_count="66">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>plt.subplots(<span class="dv">1</span>,<span class="dv">2</span>,figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">5</span>))</span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a><span class="co"># using subplot function and creating</span></span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a><span class="co"># plot one</span></span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">1</span>)</span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-7"><a href="#cb93-7" aria-hidden="true" tabindex="-1"></a><span class="co"># impulse response</span></span>
<span id="cb93-8"><a href="#cb93-8" aria-hidden="true" tabindex="-1"></a>t, y <span class="op">=</span> signal.impulse2(preamp_sys,N<span class="op">=</span><span class="dv">500</span>)</span>
<span id="cb93-9"><a href="#cb93-9" aria-hidden="true" tabindex="-1"></a>plt.plot(t<span class="op">/</span><span class="fl">1e-3</span>, y)</span>
<span id="cb93-10"><a href="#cb93-10" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'AN-346 phono preamplifier Impulse response'</span>)</span>
<span id="cb93-11"><a href="#cb93-11" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'volts'</span>)</span>
<span id="cb93-12"><a href="#cb93-12" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'time, msec'</span>)</span>
<span id="cb93-13"><a href="#cb93-13" aria-hidden="true" tabindex="-1"></a>plt.grid()</span>
<span id="cb93-14"><a href="#cb93-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-15"><a href="#cb93-15" aria-hidden="true" tabindex="-1"></a><span class="co"># using subplot function and creating plot two</span></span>
<span id="cb93-16"><a href="#cb93-16" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb93-17"><a href="#cb93-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-18"><a href="#cb93-18" aria-hidden="true" tabindex="-1"></a>t, y <span class="op">=</span> signal.step2(preamp_sys,N<span class="op">=</span><span class="dv">500</span>)</span>
<span id="cb93-19"><a href="#cb93-19" aria-hidden="true" tabindex="-1"></a>plt.plot(t<span class="op">/</span><span class="fl">1e-3</span>, y)</span>
<span id="cb93-20"><a href="#cb93-20" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'AN-346 phono preamplifier Step response'</span>)</span>
<span id="cb93-21"><a href="#cb93-21" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'volts'</span>)</span>
<span id="cb93-22"><a href="#cb93-22" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'time, msec'</span>)</span>
<span id="cb93-23"><a href="#cb93-23" aria-hidden="true" tabindex="-1"></a>plt.grid()</span>
<span id="cb93-24"><a href="#cb93-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-25"><a href="#cb93-25" aria-hidden="true" tabindex="-1"></a><span class="co"># space between the plots</span></span>
<span id="cb93-26"><a href="#cb93-26" aria-hidden="true" tabindex="-1"></a><span class="co">#plt.tight_layout(4)</span></span>
<span id="cb93-27"><a href="#cb93-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-28"><a href="#cb93-28" aria-hidden="true" tabindex="-1"></a><span class="co"># show plot</span></span>
<span id="cb93-29"><a href="#cb93-29" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Two amplifier RIAA Phono Preamp_files/figure-html/cell-66-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="group-delay" class="level3" data-number="20.4.6">
<h3 data-number="20.4.6" class="anchored" data-anchor-id="group-delay"><span class="header-section-number">20.4.6</span> Group delay</h3>
<p>The following python code calculates and plots <a href="https://en.wikipedia.org/wiki/Group_delay_and_phase_delay#">group delay</a>. Frequency components of a signal are delayed when passed through a circuit and the signal delay will be different for the various frequencies unless the circuit has the property of being linear phase. The delay variation means that signals consisting of multiple frequency components will suffer distortion because these components are not delayed by the same amount of time at the output of the device.</p>
<p>Group delay: <span class="math inline">\(\tau _{g}(\omega )=-\frac  {d\phi (\omega )}{d\omega }\)</span></p>
<div id="cell-125" class="cell" data-execution_count="67">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>w_preamp, mag_preamp, phase_preamp <span class="op">=</span> preamp_sys.bode(w<span class="op">=</span>x_axis_range)</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'AN-346 phono preamplifier group delay'</span>)</span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>plt.semilogx(w_preamp<span class="op">/</span>(<span class="dv">2</span><span class="op">*</span>np.pi), <span class="op">-</span>np.gradient(phase_preamp<span class="op">*</span>np.pi<span class="op">/</span><span class="dv">180</span>)<span class="op">/</span>np.gradient(w_preamp),<span class="st">'-'</span>,label<span class="op">=</span><span class="st">'group delay'</span>)</span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a><span class="co">#plt.semilogx(w_c1/(2*np.pi), -np.gradient(phase_c1)/w_c1/1e-3,'-',label='phase delay')</span></span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a>plt.axvspan(<span class="dv">20</span>, <span class="fl">20e3</span>, color<span class="op">=</span><span class="st">'y'</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Group delay, sec'</span>)</span>
<span id="cb94-9"><a href="#cb94-9" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Frequency, Hz'</span>)</span>
<span id="cb94-10"><a href="#cb94-10" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb94-11"><a href="#cb94-11" aria-hidden="true" tabindex="-1"></a>plt.grid()</span>
<span id="cb94-12"><a href="#cb94-12" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Two amplifier RIAA Phono Preamp_files/figure-html/cell-67-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>The plot above shows that for frequencies below 100 Hz, the group delay is as much as 4 ms in the audio band. According to paper, <a href="https://acris.aalto.fi/ws/portalfiles/portal/66449704/Audibility_of_Group_Delay_Equalization.pdf">Audibility of Group-Delay Equalization</a>, the threshold is 2 ms. The abstract for the paper states:</p>
<blockquote class="blockquote">
<p>The audibility thresholds for group-delay variation from several previous related studies are shown in Fig. 1. If not otherwise stated, these studies have been conducted using headphones. Green applied Huffman sequences, or truncated impulse responses of second-order allpass filters, to study the audibility of phase distortion. He found a threshold value for the peak group delay of about 2 ms for center frequencies of 625 Hz, 1875 Hz, and 4062 Hz.</p>
</blockquote>
<p>The preamp group delay in the low end of the audio band is of concern and some re-design should be implemented if this preamp was to be implemented. The group delay plotted above agrees with the group delay results obtained from LTSpice simulation of the preamp circuit.</p>
</section>
<section id="comparing-results-to-ltspice" class="level3" data-number="20.4.7">
<h3 data-number="20.4.7" class="anchored" data-anchor-id="comparing-results-to-ltspice"><span class="header-section-number">20.4.7</span> Comparing results to LTSpice</h3>
<p>The <a href="https://www.ti.com/lit/zip/snlm202">LM833 TINA-TI Spice Model</a> was entered into LTSpice, but it has some errors when run with LTSpice. So rather than debug the errors, an Analog Devices’s <a href="https://www.analog.com/en/products/lt1115.html">LT1115</a>, was substiuded to obtain simulation results with an opamp model in order to comapre with the Python results, which uses an ideal opamp.</p>
<p>The table blow shows that the LM833 and LT1115 have simular performance characteristics.</p>
<table class="table">
<colgroup>
<col style="width: 16%">
<col style="width: 16%">
<col style="width: 16%">
<col style="width: 16%">
<col style="width: 16%">
<col style="width: 16%">
</colgroup>
<thead>
<tr class="header">
<th>Op Amp</th>
<th>Distortion %, THD + N at 1 kHz</th>
<th>Noise, at 1 kHz (nV√Hz)</th>
<th>Slew Rate, (V/µs)</th>
<th>GBW (MHz)</th>
<th>Power Bandwidth</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>LM833N</td>
<td>0.002</td>
<td>4.5</td>
<td>7</td>
<td>15</td>
<td>120 kHz @ 27 Vpp, RL = 2 kΩ, THD ≤ 1%</td>
</tr>
<tr class="even">
<td>LT1115</td>
<td>0.002</td>
<td>0.9</td>
<td>10</td>
<td>40</td>
<td>180 kHz @ 30 VP-P, RL=2k</td>
</tr>
</tbody>
</table>
<div id="cell-127" class="cell" data-execution_count="68">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>os.chdir(<span class="st">'/home/jeff32/Documents/Solving Electrical Engineering Problems with Python Blog/MNA Problem Circuits/Two amplifier RIAA Phone Preamp/'</span>) <span class="co"># change directory to csv file location</span></span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>fn <span class="op">=</span> <span class="st">'Two amplifier RIAA Phone Preamp.csv'</span> <span class="co"># data from LTSpice</span></span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a>LTSpice_data <span class="op">=</span> np.genfromtxt(fn, delimiter<span class="op">=</span><span class="st">','</span>)</span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a><span class="co"># change the working director back to the Jupyter folder</span></span>
<span id="cb95-7"><a href="#cb95-7" aria-hidden="true" tabindex="-1"></a>os.chdir(<span class="st">'/home/jeff32/Documents/JupyterLab/Node Analysis/'</span>)  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-128" class="cell" data-execution_count="69">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>frequency <span class="op">=</span> np.zeros(<span class="bu">len</span>(LTSpice_data))</span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>voltage <span class="op">=</span> np.zeros(<span class="bu">len</span>(LTSpice_data)).astype(<span class="bu">complex</span>)</span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(LTSpice_data)):</span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a>    frequency[i] <span class="op">=</span> LTSpice_data[i][<span class="dv">0</span>]</span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a>    voltage[i] <span class="op">=</span> LTSpice_data[i][<span class="dv">1</span>] <span class="op">+</span> LTSpice_data[i][<span class="dv">2</span>]<span class="op">*</span><span class="ot">1j</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-129" class="cell" data-execution_count="70">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>fig, ax1 <span class="op">=</span> plt.subplots()</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>ax1.set_ylabel(<span class="st">'magnitude, dB'</span>)</span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>ax1.set_xlabel(<span class="st">'frequency, Hz'</span>)</span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a>plt.semilogx(frequency, <span class="dv">20</span><span class="op">*</span>np.log10(np.<span class="bu">abs</span>(voltage))<span class="op">+</span><span class="fl">11.257</span>,<span class="st">'-k'</span>)    <span class="co"># Bode magnitude plot, adding 11.257 dBV offset to normalized LTSpice data at 1KHz</span></span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a>plt.semilogx(w_preamp<span class="op">/</span>(<span class="dv">2</span><span class="op">*</span>np.pi), mag_preamp<span class="op">-</span>preamp_gain_1kHz,<span class="st">'-b'</span>)    <span class="co"># Bode magnitude plot</span></span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-8"><a href="#cb97-8" aria-hidden="true" tabindex="-1"></a>ax1.tick_params(axis<span class="op">=</span><span class="st">'y'</span>)</span>
<span id="cb97-9"><a href="#cb97-9" aria-hidden="true" tabindex="-1"></a>ax1.set_ylim((<span class="op">-</span><span class="dv">40</span>,<span class="dv">20</span>))</span>
<span id="cb97-10"><a href="#cb97-10" aria-hidden="true" tabindex="-1"></a>plt.grid()</span>
<span id="cb97-11"><a href="#cb97-11" aria-hidden="true" tabindex="-1"></a>plt.axvspan(<span class="dv">20</span>, <span class="fl">20e3</span>, color<span class="op">=</span><span class="st">'y'</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb97-12"><a href="#cb97-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-13"><a href="#cb97-13" aria-hidden="true" tabindex="-1"></a><span class="co"># instantiate a second y-axes that shares the same x-axis</span></span>
<span id="cb97-14"><a href="#cb97-14" aria-hidden="true" tabindex="-1"></a>ax2 <span class="op">=</span> ax1.twinx()</span>
<span id="cb97-15"><a href="#cb97-15" aria-hidden="true" tabindex="-1"></a>color <span class="op">=</span> <span class="st">'blue'</span></span>
<span id="cb97-16"><a href="#cb97-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-17"><a href="#cb97-17" aria-hidden="true" tabindex="-1"></a>plt.semilogx(frequency, np.angle(voltage)<span class="op">*</span><span class="dv">180</span><span class="op">/</span>np.pi,<span class="st">':'</span>,color<span class="op">=</span>color,label<span class="op">=</span><span class="st">'LT1115 phase'</span>)  <span class="co"># Bode phase plot</span></span>
<span id="cb97-18"><a href="#cb97-18" aria-hidden="true" tabindex="-1"></a>plt.semilogx(w_preamp<span class="op">/</span>(<span class="dv">2</span><span class="op">*</span>np.pi), phase_preamp,<span class="st">':'</span>,color<span class="op">=</span><span class="st">'black'</span>,label<span class="op">=</span><span class="st">'MNA phase'</span>)  <span class="co"># Bode phase plot</span></span>
<span id="cb97-19"><a href="#cb97-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-20"><a href="#cb97-20" aria-hidden="true" tabindex="-1"></a>ax2.set_ylabel(<span class="st">'phase, deg'</span>,color<span class="op">=</span>color)</span>
<span id="cb97-21"><a href="#cb97-21" aria-hidden="true" tabindex="-1"></a>ax2.tick_params(axis<span class="op">=</span><span class="st">'y'</span>, labelcolor<span class="op">=</span>color)</span>
<span id="cb97-22"><a href="#cb97-22" aria-hidden="true" tabindex="-1"></a><span class="co">#ax2.set_ylim((-5,25))</span></span>
<span id="cb97-23"><a href="#cb97-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-24"><a href="#cb97-24" aria-hidden="true" tabindex="-1"></a>ax2.plot(np.NaN, np.NaN, <span class="st">'-'</span>, color<span class="op">=</span><span class="st">'b'</span>, label<span class="op">=</span><span class="st">'LT1115 magnitude'</span>)</span>
<span id="cb97-25"><a href="#cb97-25" aria-hidden="true" tabindex="-1"></a>ax2.plot(np.NaN, np.NaN, <span class="st">'-.'</span>, color<span class="op">=</span><span class="st">'k'</span>, label<span class="op">=</span><span class="st">'MNA magnitude'</span>)</span>
<span id="cb97-26"><a href="#cb97-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-27"><a href="#cb97-27" aria-hidden="true" tabindex="-1"></a>plt.legend(loc<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb97-28"><a href="#cb97-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-29"><a href="#cb97-29" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Bode plot'</span>)</span>
<span id="cb97-30"><a href="#cb97-30" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Two amplifier RIAA Phono Preamp_files/figure-html/cell-70-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>As is evident in the plot above, the results from LTSpice and Python agree.</p>
</section>
<section id="preamplifier-deviation-from-riaa-response" class="level3" data-number="20.4.8">
<h3 data-number="20.4.8" class="anchored" data-anchor-id="preamplifier-deviation-from-riaa-response"><span class="header-section-number">20.4.8</span> Preamplifier deviation from RIAA response</h3>
<p>The plot below shows the deviation of the preamplifier from the RIAA response. The TI app note says conformance to the RIAA curve is within 0.1 dB from 20 Hz to 20 kHz.</p>
<div id="cell-131" class="cell" data-execution_count="71">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>fig, ax1 <span class="op">=</span> plt.subplots()</span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>ax1.set_ylabel(<span class="st">'magnitude, dB'</span>)</span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a>ax1.set_xlabel(<span class="st">'frequency, Hz'</span>)</span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a>plt.semilogx(w_preamp<span class="op">/</span>(<span class="dv">2</span><span class="op">*</span>np.pi), (mag_RIAA<span class="op">-</span>RIAA_gain_1kHz) <span class="op">+</span> mag_preamp<span class="op">-</span>preamp_gain_1kHz,<span class="st">'-k'</span>)    <span class="co"># Bode magnitude plot</span></span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true" tabindex="-1"></a>ax1.tick_params(axis<span class="op">=</span><span class="st">'y'</span>)</span>
<span id="cb98-8"><a href="#cb98-8" aria-hidden="true" tabindex="-1"></a>ax1.set_ylim((<span class="op">-</span><span class="fl">0.2</span>,<span class="fl">0.1</span>))</span>
<span id="cb98-9"><a href="#cb98-9" aria-hidden="true" tabindex="-1"></a>plt.grid()</span>
<span id="cb98-10"><a href="#cb98-10" aria-hidden="true" tabindex="-1"></a>plt.axvspan(<span class="dv">20</span>, <span class="fl">20e3</span>, color<span class="op">=</span><span class="st">'y'</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb98-11"><a href="#cb98-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-12"><a href="#cb98-12" aria-hidden="true" tabindex="-1"></a><span class="co"># instantiate a second y-axes that shares the same x-axis</span></span>
<span id="cb98-13"><a href="#cb98-13" aria-hidden="true" tabindex="-1"></a>ax2 <span class="op">=</span> ax1.twinx()</span>
<span id="cb98-14"><a href="#cb98-14" aria-hidden="true" tabindex="-1"></a>color <span class="op">=</span> <span class="st">'tab:blue'</span></span>
<span id="cb98-15"><a href="#cb98-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-16"><a href="#cb98-16" aria-hidden="true" tabindex="-1"></a>plt.semilogx(w_preamp<span class="op">/</span>(<span class="dv">2</span><span class="op">*</span>np.pi), phase_RIAA<span class="op">+</span>phase_preamp,<span class="st">':'</span>,color<span class="op">=</span>color,label<span class="op">=</span><span class="st">'phase of S2'</span>)  <span class="co"># Bode phase plot</span></span>
<span id="cb98-17"><a href="#cb98-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-18"><a href="#cb98-18" aria-hidden="true" tabindex="-1"></a>ax2.set_ylabel(<span class="st">'phase, deg'</span>,color<span class="op">=</span>color)</span>
<span id="cb98-19"><a href="#cb98-19" aria-hidden="true" tabindex="-1"></a>ax2.tick_params(axis<span class="op">=</span><span class="st">'y'</span>, labelcolor<span class="op">=</span>color)</span>
<span id="cb98-20"><a href="#cb98-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-21"><a href="#cb98-21" aria-hidden="true" tabindex="-1"></a>ax2.plot(np.NaN, np.NaN, <span class="st">'-'</span>, color<span class="op">=</span><span class="st">'k'</span>, label<span class="op">=</span><span class="st">'magnitude of S1'</span>)</span>
<span id="cb98-22"><a href="#cb98-22" aria-hidden="true" tabindex="-1"></a>plt.legend(loc<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb98-23"><a href="#cb98-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-24"><a href="#cb98-24" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Bode plot'</span>)</span>
<span id="cb98-25"><a href="#cb98-25" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Two amplifier RIAA Phono Preamp_files/figure-html/cell-71-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>The calculations below will find the minimum and maximunation deviation of the amplitude response from the RIAA curve.</p>
<div id="cell-133" class="cell" data-execution_count="72">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>idx_low <span class="op">=</span> np.where(w_preamp<span class="op">/</span>(<span class="dv">2</span><span class="op">*</span>np.pi) <span class="op">&gt;</span> <span class="dv">20</span>)[<span class="dv">0</span>][<span class="dv">0</span>]</span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>idx_high <span class="op">=</span> np.where(w_preamp<span class="op">/</span>(<span class="dv">2</span><span class="op">*</span>np.pi) <span class="op">&gt;</span> <span class="fl">20e3</span>)[<span class="dv">0</span>][<span class="dv">0</span>]</span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'preamp deviation from RIAA curve: </span><span class="sc">{:.3f}</span><span class="st"> to </span><span class="sc">{:.3f}</span><span class="st"> dB'</span>.<span class="bu">format</span>(((mag_RIAA<span class="op">-</span>RIAA_gain_1kHz) <span class="op">+</span> mag_preamp<span class="op">-</span>preamp_gain_1kHz)[idx_low:idx_high].<span class="bu">min</span>(),((mag_RIAA<span class="op">-</span>RIAA_gain_1kHz) <span class="op">+</span> mag_preamp<span class="op">-</span>preamp_gain_1kHz)[idx_low:idx_high].<span class="bu">max</span>()))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>preamp deviation from RIAA curve: -0.045 to 0.066 dB</code></pre>
</div>
</div>
<p>The calculations above show that within the audio range the deviation of the preamp amplitude response from the RIAA curve varies from -0.044 to 0.066 dB when the nominal component values are used.</p>
</section>
<section id="sensitivity-analysis" class="level3" data-number="20.4.9">
<h3 data-number="20.4.9" class="anchored" data-anchor-id="sensitivity-analysis"><span class="header-section-number">20.4.9</span> Sensitivity analysis</h3>
<p>All circuits have characteristics that dependent on the values of the component. The sensitivity of a circuit’s performance is a measure of how much a particular circuit characteristic changes as a particular component value varies. In this analysis i’ll look at the changes of each pole or zero relative to the compenents value.</p>
<p>The root sensitivity function <span class="math inline">\(S_x^y\)</span> gives the change occuring in filter characteristic per <span class="math inline">\(\delta y/ \delta x\)</span>.</p>
<p><span class="math inline">\(S_x^y\)</span> is read as the sensitivity of the characteristic (i.e.&nbsp;y = <span class="math inline">\(\omega_n,\)</span> or Q or some other characteristic) with respect to the element x.</p>
<p><span class="math inline">\(S_x^y = \frac {x}{y} \frac{\delta y}{\delta x}\)</span></p>
<p>Where x is the filter component that is varied and y is the filter characteristic (<span class="math inline">\(\omega_n,\)</span> or Q etc.) that we wish to evaluate as x is varied.</p>
<p>The preamp transfer function is symbolic form is, H_preamp_sym, and we can get the numerator and denominator with the SymPy fraction function.</p>
<div id="cell-135" class="cell" data-execution_count="73">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>H_sym_num, H_sym_denom <span class="op">=</span> fraction(H_preamp_sym)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The Sympy solve function is used to find the root of the numerator and denimator polynominals.</p>
<div id="cell-137" class="cell" data-execution_count="74">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>H_sym_zeros <span class="op">=</span> solve(H_sym_num,s)</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>H_sym_poles <span class="op">=</span> solve(H_sym_denom,s)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="zeros" class="level4" data-number="20.4.9.1">
<h4 data-number="20.4.9.1" class="anchored" data-anchor-id="zeros"><span class="header-section-number">20.4.9.1</span> Zeros</h4>
<p>How many roots are there for the numerator polynominial?</p>
<div id="cell-139" class="cell" data-execution_count="75">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'there are </span><span class="sc">{:d}</span><span class="st"> zeros'</span>.<span class="bu">format</span>(<span class="bu">len</span>(H_sym_zeros)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>there are 3 zeros</code></pre>
</div>
</div>
</section>
<section id="z0" class="level4" data-number="20.4.9.2">
<h4 data-number="20.4.9.2" class="anchored" data-anchor-id="z0"><span class="header-section-number">20.4.9.2</span> Z0</h4>
<p>The first zero is at DC.</p>
<div id="cell-141" class="cell" data-execution_count="76">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a>H_sym_Z0 <span class="op">=</span> H_sym_zeros[<span class="dv">0</span>]</span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>H_sym_Z0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display cell-output-markdown" data-execution_count="76">
<p><span class="math inline">\(\displaystyle 0\)</span></p>
</div>
</div>
</section>
<section id="z1" class="level4" data-number="20.4.9.3">
<h4 data-number="20.4.9.3" class="anchored" data-anchor-id="z1"><span class="header-section-number">20.4.9.3</span> Z1</h4>
<p>The second zero is given symbolically by the expression:</p>
<div id="cell-143" class="cell" data-execution_count="77">
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>H_sym_Z1 <span class="op">=</span> H_sym_zeros[<span class="dv">1</span>]</span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>H_sym_Z1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display cell-output-markdown" data-execution_count="77">
<p><span class="math inline">\(\displaystyle - \frac{C_{1} R_{1} + Co R_{1} + Co R_{2} + Co Ro}{2 C_{1} Co R_{1} \left(R_{2} + Ro\right)} - \frac{\sqrt{C_{1}^{2} R_{1}^{2} + 2 C_{1} Co R_{1}^{2} - 2 C_{1} Co R_{1} R_{2} - 2 C_{1} Co R_{1} Ro + Co^{2} R_{1}^{2} + 2 Co^{2} R_{1} R_{2} + 2 Co^{2} R_{1} Ro + Co^{2} R_{2}^{2} + 2 Co^{2} R_{2} Ro + Co^{2} Ro^{2}}}{2 C_{1} Co R_{1} \left(R_{2} + Ro\right)}\)</span></p>
</div>
</div>
<p>What are the compenets that determine Z1?</p>
<div id="cell-145" class="cell" data-execution_count="78">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'the compenets that determine Z1 are: </span><span class="sc">{:s}</span><span class="st"> '</span>.<span class="bu">format</span>(<span class="bu">str</span>(H_sym_Z1.free_symbols)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>the compenets that determine Z1 are: {R2, Ro, R1, C1, Co} </code></pre>
</div>
</div>
<p>What is the locations of Z1?</p>
<div id="cell-147" class="cell" data-execution_count="79">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'location of zero: </span><span class="sc">{:.2f}</span><span class="st"> Hz'</span>.<span class="bu">format</span>(N(H_sym_Z1.subs(nominal_component_value))<span class="op">/</span>(<span class="dv">2</span><span class="op">*</span>np.pi)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>location of zero: -506.73 Hz</code></pre>
</div>
</div>
<p>Z1 is the zero at 500 Hz and is one of the RIAA time constants.</p>
<p>We can fine the sensitivity of Z1 to C1 with the following operation.</p>
<div id="cell-150" class="cell" data-execution_count="80">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>S_C1_H_sym_Z1 <span class="op">=</span> (C1<span class="op">/</span>H_sym_Z1)<span class="op">*</span>(H_sym_Z1.diff(C1))</span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a>S_C1_H_sym_Z1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display cell-output-markdown" data-execution_count="80">
<p><span class="math inline">\(\displaystyle \frac{C_{1} \left(- \frac{1}{2 C_{1} Co \left(R_{2} + Ro\right)} - \frac{C_{1} R_{1}^{2} + Co R_{1}^{2} - Co R_{1} R_{2} - Co R_{1} Ro}{2 C_{1} Co R_{1} \left(R_{2} + Ro\right) \sqrt{C_{1}^{2} R_{1}^{2} + 2 C_{1} Co R_{1}^{2} - 2 C_{1} Co R_{1} R_{2} - 2 C_{1} Co R_{1} Ro + Co^{2} R_{1}^{2} + 2 Co^{2} R_{1} R_{2} + 2 Co^{2} R_{1} Ro + Co^{2} R_{2}^{2} + 2 Co^{2} R_{2} Ro + Co^{2} Ro^{2}}} + \frac{C_{1} R_{1} + Co R_{1} + Co R_{2} + Co Ro}{2 C_{1}^{2} Co R_{1} \left(R_{2} + Ro\right)} + \frac{\sqrt{C_{1}^{2} R_{1}^{2} + 2 C_{1} Co R_{1}^{2} - 2 C_{1} Co R_{1} R_{2} - 2 C_{1} Co R_{1} Ro + Co^{2} R_{1}^{2} + 2 Co^{2} R_{1} R_{2} + 2 Co^{2} R_{1} Ro + Co^{2} R_{2}^{2} + 2 Co^{2} R_{2} Ro + Co^{2} Ro^{2}}}{2 C_{1}^{2} Co R_{1} \left(R_{2} + Ro\right)}\right)}{- \frac{C_{1} R_{1} + Co R_{1} + Co R_{2} + Co Ro}{2 C_{1} Co R_{1} \left(R_{2} + Ro\right)} - \frac{\sqrt{C_{1}^{2} R_{1}^{2} + 2 C_{1} Co R_{1}^{2} - 2 C_{1} Co R_{1} R_{2} - 2 C_{1} Co R_{1} Ro + Co^{2} R_{1}^{2} + 2 Co^{2} R_{1} R_{2} + 2 Co^{2} R_{1} Ro + Co^{2} R_{2}^{2} + 2 Co^{2} R_{2} Ro + Co^{2} Ro^{2}}}{2 C_{1} Co R_{1} \left(R_{2} + Ro\right)}}\)</span></p>
</div>
</div>
<p>Evaluating this numerically with the component values, we get get the sensitivity of Z1 to C1.</p>
<div id="cell-152" class="cell" data-execution_count="81">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'the sensitivity of Z1 to C1 is: </span><span class="sc">{:.2f}</span><span class="st">'</span>.<span class="bu">format</span>(N(S_C1_H_sym_Z1.subs(nominal_component_value))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>the sensitivity of Z1 to C1 is: -1.00</code></pre>
</div>
</div>
<p>Doing the math with SymPy, we can get the sensitivity of Z1 to the other components.</p>
<div id="cell-154" class="cell" data-execution_count="82">
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a>S_R1_H_sym_Z1 <span class="op">=</span> (R1<span class="op">/</span>H_sym_Z1)<span class="op">*</span>(H_sym_Z1.diff(R1))</span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'the sensitivity of Z1 to R1 is: </span><span class="sc">{:.2f}</span><span class="st">'</span>.<span class="bu">format</span>(N(S_R1_H_sym_Z1.subs(nominal_component_value))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>the sensitivity of Z1 to R1 is: -0.10</code></pre>
</div>
</div>
<div id="cell-155" class="cell" data-execution_count="83">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>S_R2_H_sym_Z1 <span class="op">=</span> (R2<span class="op">/</span>H_sym_Z1)<span class="op">*</span>(H_sym_Z1.diff(R2))</span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'the sensitivity of Z1 to R2 is: </span><span class="sc">{:.2f}</span><span class="st">'</span>.<span class="bu">format</span>(N(S_R2_H_sym_Z1.subs(nominal_component_value))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>the sensitivity of Z1 to R2 is: -0.85</code></pre>
</div>
</div>
<div id="cell-156" class="cell" data-execution_count="84">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a>S_Co_H_sym_Z1 <span class="op">=</span> (Co<span class="op">/</span>H_sym_Z1)<span class="op">*</span>(H_sym_Z1.diff(Co))</span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'the sensitivity of Z1 to Co is: </span><span class="sc">{:.4f}</span><span class="st">'</span>.<span class="bu">format</span>(N(S_Co_H_sym_Z1.subs(nominal_component_value))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>the sensitivity of Z1 to Co is: -0.0002</code></pre>
</div>
</div>
<div id="cell-157" class="cell" data-execution_count="85">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a>S_Ro_H_sym_Z1 <span class="op">=</span> (Ro<span class="op">/</span>H_sym_Z1)<span class="op">*</span>(H_sym_Z1.diff(Ro))</span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'the sensitivity of Z1 to Ro is: </span><span class="sc">{:.2f}</span><span class="st">'</span>.<span class="bu">format</span>(N(S_Ro_H_sym_Z1.subs(nominal_component_value))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>the sensitivity of Z1 to Ro is: -0.05</code></pre>
</div>
</div>
<p>Later, we we are doing the worst case analsys, we can ignore Co.&nbsp;</p>
</section>
<section id="z2" class="level4" data-number="20.4.9.4">
<h4 data-number="20.4.9.4" class="anchored" data-anchor-id="z2"><span class="header-section-number">20.4.9.4</span> Z2</h4>
<p>The third zero of the transfer function is Z2.</p>
<div id="cell-159" class="cell" data-execution_count="86">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a>H_sym_Z2 <span class="op">=</span> H_sym_zeros[<span class="dv">2</span>]</span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>H_sym_Z2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display cell-output-markdown" data-execution_count="86">
<p><span class="math inline">\(\displaystyle - \frac{C_{1} R_{1} + Co R_{1} + Co R_{2} + Co Ro}{2 C_{1} Co R_{1} \left(R_{2} + Ro\right)} + \frac{\sqrt{C_{1}^{2} R_{1}^{2} + 2 C_{1} Co R_{1}^{2} - 2 C_{1} Co R_{1} R_{2} - 2 C_{1} Co R_{1} Ro + Co^{2} R_{1}^{2} + 2 Co^{2} R_{1} R_{2} + 2 Co^{2} R_{1} Ro + Co^{2} R_{2}^{2} + 2 Co^{2} R_{2} Ro + Co^{2} Ro^{2}}}{2 C_{1} Co R_{1} \left(R_{2} + Ro\right)}\)</span></p>
</div>
</div>
<div id="cell-160" class="cell" data-execution_count="87">
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'the compenets that determine Z2 are: </span><span class="sc">{:s}</span><span class="st"> '</span>.<span class="bu">format</span>(<span class="bu">str</span>(H_sym_Z2.free_symbols)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>the compenets that determine Z2 are: {R2, Ro, R1, C1, Co} </code></pre>
</div>
</div>
<div id="cell-161" class="cell" data-execution_count="88">
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Z2: </span><span class="sc">{:.3e}</span><span class="st"> Hz'</span>.<span class="bu">format</span>(N(H_sym_Z2.subs(nominal_component_value))<span class="op">/</span>(<span class="dv">2</span><span class="op">*</span>np.pi)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Z2: -8.885e-3 Hz</code></pre>
</div>
</div>
<p>The zero Z2, evaluates to a system zero at DC and is not one the of RIAA time constants.</p>
<div id="cell-163" class="cell" data-execution_count="89">
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a>S_C1_H_sym_Z2 <span class="op">=</span> (C1<span class="op">/</span>H_sym_Z2)<span class="op">*</span>(H_sym_Z2.diff(C1))</span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'the sensitivity of Z2 to C1 is: </span><span class="sc">{:.3e}</span><span class="st">'</span>.<span class="bu">format</span>(N(S_C1_H_sym_Z2.subs(nominal_component_value))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>the sensitivity of Z2 to C1 is: -1.580e-4</code></pre>
</div>
</div>
<div id="cell-164" class="cell" data-execution_count="90">
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a>S_Co_H_sym_Z2 <span class="op">=</span> (Co<span class="op">/</span>H_sym_Z2)<span class="op">*</span>(H_sym_Z2.diff(Co))</span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'the sensitivity of Z2 to Co is: </span><span class="sc">{:.2f}</span><span class="st">'</span>.<span class="bu">format</span>(N(S_Co_H_sym_Z2.subs(nominal_component_value))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>the sensitivity of Z2 to Co is: -1.00</code></pre>
</div>
</div>
<div id="cell-165" class="cell" data-execution_count="91">
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a>S_R1_H_sym_Z2 <span class="op">=</span> (R1<span class="op">/</span>H_sym_Z2)<span class="op">*</span>(H_sym_Z2.diff(R1))</span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'the sensitivity of Z2 to R1 is: </span><span class="sc">{:.2f}</span><span class="st">'</span>.<span class="bu">format</span>(N(S_R1_H_sym_Z2.subs(nominal_component_value))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>the sensitivity of Z2 to R1 is: -0.90</code></pre>
</div>
</div>
<div id="cell-166" class="cell" data-execution_count="92">
<div class="sourceCode cell-code" id="cb133"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a>S_R2_H_sym_Z2 <span class="op">=</span> (R2<span class="op">/</span>H_sym_Z2)<span class="op">*</span>(H_sym_Z2.diff(R2))</span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'the sensitivity of Z2 to R2 is: </span><span class="sc">{:.2f}</span><span class="st">'</span>.<span class="bu">format</span>(N(S_R2_H_sym_Z2.subs(nominal_component_value))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>the sensitivity of Z2 to R2 is: -0.09</code></pre>
</div>
</div>
<div id="cell-167" class="cell" data-execution_count="93">
<div class="sourceCode cell-code" id="cb135"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a>S_Ro_H_sym_Z2 <span class="op">=</span> (Ro<span class="op">/</span>H_sym_Z2)<span class="op">*</span>(H_sym_Z2.diff(Ro))</span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'the sensitivity of Z2 to Ro is: </span><span class="sc">{:.3f}</span><span class="st">'</span>.<span class="bu">format</span>(N(S_Ro_H_sym_Z2.subs(nominal_component_value))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>the sensitivity of Z2 to Ro is: -0.006</code></pre>
</div>
</div>
</section>
<section id="poles" class="level4" data-number="20.4.9.5">
<h4 data-number="20.4.9.5" class="anchored" data-anchor-id="poles"><span class="header-section-number">20.4.9.5</span> Poles</h4>
<p>How many poles are there in the preamp transfer function?</p>
<div id="cell-169" class="cell" data-execution_count="94">
<div class="sourceCode cell-code" id="cb137"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'there are </span><span class="sc">{:d}</span><span class="st"> poles in the transfer function'</span>.<span class="bu">format</span>(<span class="bu">len</span>(H_sym_poles)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>there are 4 poles in the transfer function</code></pre>
</div>
</div>
</section>
<section id="p0" class="level4" data-number="20.4.9.6">
<h4 data-number="20.4.9.6" class="anchored" data-anchor-id="p0"><span class="header-section-number">20.4.9.6</span> P0</h4>
<p>The first pole is:</p>
<div id="cell-171" class="cell" data-execution_count="95">
<div class="sourceCode cell-code" id="cb139"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a>H_sym_P0 <span class="op">=</span> H_sym_poles[<span class="dv">0</span>]</span>
<span id="cb139-2"><a href="#cb139-2" aria-hidden="true" tabindex="-1"></a>H_sym_P0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display cell-output-markdown" data-execution_count="95">
<p><span class="math inline">\(\displaystyle - \frac{1}{C_{1} R_{1}}\)</span></p>
</div>
</div>
<p>The pole P0 evaluates to one of the RIAA time constants.</p>
<div id="cell-173" class="cell" data-execution_count="96">
<div class="sourceCode cell-code" id="cb140"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'P0: </span><span class="sc">{:.2f}</span><span class="st">Hz'</span>.<span class="bu">format</span>(N(H_sym_P0.subs(nominal_component_value))<span class="op">/</span>(<span class="dv">2</span><span class="op">*</span>np.pi)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>P0: -50.63Hz</code></pre>
</div>
</div>
<div id="cell-174" class="cell" data-execution_count="97">
<div class="sourceCode cell-code" id="cb142"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a>S_C1_H_sym_P0 <span class="op">=</span> (C1<span class="op">/</span>H_sym_P0)<span class="op">*</span>(H_sym_P0.diff(C1))</span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'the sensitivity of P0 to C1 is: </span><span class="sc">{:.2f}</span><span class="st">'</span>.<span class="bu">format</span>(N(S_C1_H_sym_P0.subs(nominal_component_value))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>the sensitivity of P0 to C1 is: -1.00</code></pre>
</div>
</div>
<div id="cell-175" class="cell" data-execution_count="98">
<div class="sourceCode cell-code" id="cb144"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a>S_R1_H_sym_P0 <span class="op">=</span> (R1<span class="op">/</span>H_sym_P0)<span class="op">*</span>(H_sym_P0.diff(R1))</span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'the sensitivity of P0 to R1 is: </span><span class="sc">{:.2f}</span><span class="st">'</span>.<span class="bu">format</span>(N(S_R1_H_sym_P0.subs(nominal_component_value))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>the sensitivity of P0 to R1 is: -1.00</code></pre>
</div>
</div>
</section>
<section id="p1" class="level4" data-number="20.4.9.7">
<h4 data-number="20.4.9.7" class="anchored" data-anchor-id="p1"><span class="header-section-number">20.4.9.7</span> P1</h4>
<p>The second pole is:</p>
<div id="cell-177" class="cell" data-execution_count="99">
<div class="sourceCode cell-code" id="cb146"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a>H_sym_P1 <span class="op">=</span> H_sym_poles[<span class="dv">1</span>]</span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a>H_sym_P1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display cell-output-markdown" data-execution_count="99">
<p><span class="math inline">\(\displaystyle - \frac{1}{Co Ro}\)</span></p>
</div>
</div>
<p>The pole P1 evaluates to a frequency near DC.</p>
<div id="cell-179" class="cell" data-execution_count="100">
<div class="sourceCode cell-code" id="cb147"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'P1: </span><span class="sc">{:.2f}</span><span class="st">Hz'</span>.<span class="bu">format</span>(N(H_sym_P1.subs(nominal_component_value))<span class="op">/</span>(<span class="dv">2</span><span class="op">*</span>np.pi)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>P1: -1.59Hz</code></pre>
</div>
</div>
<div id="cell-180" class="cell" data-execution_count="101">
<div class="sourceCode cell-code" id="cb149"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a>S_Co_H_sym_P1 <span class="op">=</span> (Co<span class="op">/</span>H_sym_P1)<span class="op">*</span>(H_sym_P1.diff(Co))</span>
<span id="cb149-2"><a href="#cb149-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'the sensitivity of P1 to Co is: </span><span class="sc">{:.2f}</span><span class="st">'</span>.<span class="bu">format</span>(N(S_Co_H_sym_P1.subs(nominal_component_value))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>the sensitivity of P1 to Co is: -1.00</code></pre>
</div>
</div>
<div id="cell-181" class="cell" data-execution_count="102">
<div class="sourceCode cell-code" id="cb151"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a>S_Ro_H_sym_P1 <span class="op">=</span> (Ro<span class="op">/</span>H_sym_P1)<span class="op">*</span>(H_sym_P1.diff(Ro))</span>
<span id="cb151-2"><a href="#cb151-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'the sensitivity of P1 to Ro is: </span><span class="sc">{:.2f}</span><span class="st">'</span>.<span class="bu">format</span>(N(S_Ro_H_sym_P1.subs(nominal_component_value))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>the sensitivity of P1 to Ro is: -1.00</code></pre>
</div>
</div>
</section>
<section id="p2" class="level4" data-number="20.4.9.8">
<h4 data-number="20.4.9.8" class="anchored" data-anchor-id="p2"><span class="header-section-number">20.4.9.8</span> P2</h4>
<p>The 3rd pole is:</p>
<div id="cell-183" class="cell" data-execution_count="103">
<div class="sourceCode cell-code" id="cb153"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a>H_sym_P2 <span class="op">=</span> H_sym_poles[<span class="dv">2</span>]</span>
<span id="cb153-2"><a href="#cb153-2" aria-hidden="true" tabindex="-1"></a>H_sym_P2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display cell-output-markdown" data-execution_count="103">
<p><span class="math inline">\(\displaystyle \frac{- C_{3} R_{3} - C_{4} R_{3} - C_{4} R_{6} - \sqrt{C_{3}^{2} R_{3}^{2} + 2 C_{3} C_{4} R_{3}^{2} - 2 C_{3} C_{4} R_{3} R_{6} + C_{4}^{2} R_{3}^{2} + 2 C_{4}^{2} R_{3} R_{6} + C_{4}^{2} R_{6}^{2}}}{2 C_{3} C_{4} R_{3} R_{6}}\)</span></p>
</div>
</div>
<div id="cell-184" class="cell" data-execution_count="104">
<div class="sourceCode cell-code" id="cb154"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'the compenets that determine P2 are: </span><span class="sc">{:s}</span><span class="st"> '</span>.<span class="bu">format</span>(<span class="bu">str</span>(H_sym_P2.free_symbols)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>the compenets that determine P2 are: {R3, R6, C4, C3} </code></pre>
</div>
</div>
<div id="cell-185" class="cell" data-execution_count="105">
<div class="sourceCode cell-code" id="cb156"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'P2: </span><span class="sc">{:.2f}</span><span class="st">Hz'</span>.<span class="bu">format</span>(N(H_sym_P2.subs(nominal_component_value))<span class="op">/</span>(<span class="dv">2</span><span class="op">*</span>np.pi)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>P2: -2122.88Hz</code></pre>
</div>
</div>
<div id="cell-186" class="cell" data-execution_count="106">
<div class="sourceCode cell-code" id="cb158"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a>S_C3_H_sym_P2 <span class="op">=</span> (C3<span class="op">/</span>H_sym_P2)<span class="op">*</span>(H_sym_P2.diff(C3))</span>
<span id="cb158-2"><a href="#cb158-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'the sensitivity of P2 to C3 is: </span><span class="sc">{:.2f}</span><span class="st">'</span>.<span class="bu">format</span>(N(S_C3_H_sym_P2.subs(nominal_component_value))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>the sensitivity of P2 to C3 is: -1.00</code></pre>
</div>
</div>
<div id="cell-187" class="cell" data-execution_count="110">
<div class="sourceCode cell-code" id="cb160"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a>S_C4_H_sym_P2 <span class="op">=</span> (C4<span class="op">/</span>H_sym_P2)<span class="op">*</span>(H_sym_P2.diff(C4))</span>
<span id="cb160-2"><a href="#cb160-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'the sensitivity of P2 to C4 is: </span><span class="sc">{:.3e}</span><span class="st">'</span>.<span class="bu">format</span>(N(S_C4_H_sym_P2.subs(nominal_component_value))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>the sensitivity of P2 to C4 is: -2.829e-5</code></pre>
</div>
</div>
<div id="cell-188" class="cell" data-execution_count="111">
<div class="sourceCode cell-code" id="cb162"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a>S_R3_H_sym_P2 <span class="op">=</span> (R3<span class="op">/</span>H_sym_P2)<span class="op">*</span>(H_sym_P2.diff(R3))</span>
<span id="cb162-2"><a href="#cb162-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'the sensitivity of P2 to R3 is: </span><span class="sc">{:.2f}</span><span class="st">'</span>.<span class="bu">format</span>(N(S_R3_H_sym_P2.subs(nominal_component_value))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>the sensitivity of P2 to R3 is: -0.96</code></pre>
</div>
</div>
<div id="cell-189" class="cell" data-execution_count="115">
<div class="sourceCode cell-code" id="cb164"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb164-1"><a href="#cb164-1" aria-hidden="true" tabindex="-1"></a>S_R6_H_sym_P2 <span class="op">=</span> (R6<span class="op">/</span>H_sym_P2)<span class="op">*</span>(H_sym_P2.diff(R6))</span>
<span id="cb164-2"><a href="#cb164-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'the sensitivity of P2 to R6 is: </span><span class="sc">{:.3f}</span><span class="st">'</span>.<span class="bu">format</span>(N(S_R6_H_sym_P2.subs(nominal_component_value))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>the sensitivity of P2 to R6 is: -0.041</code></pre>
</div>
</div>
</section>
<section id="p3" class="level4" data-number="20.4.9.9">
<h4 data-number="20.4.9.9" class="anchored" data-anchor-id="p3"><span class="header-section-number">20.4.9.9</span> P3</h4>
<p>The 4th pole is:</p>
<div id="cell-191" class="cell" data-execution_count="116">
<div class="sourceCode cell-code" id="cb166"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb166-1"><a href="#cb166-1" aria-hidden="true" tabindex="-1"></a>H_sym_P3 <span class="op">=</span> H_sym_poles[<span class="dv">3</span>]</span>
<span id="cb166-2"><a href="#cb166-2" aria-hidden="true" tabindex="-1"></a>H_sym_P3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display cell-output-markdown" data-execution_count="116">
<p><span class="math inline">\(\displaystyle \frac{- C_{3} R_{3} - C_{4} R_{3} - C_{4} R_{6} + \sqrt{C_{3}^{2} R_{3}^{2} + 2 C_{3} C_{4} R_{3}^{2} - 2 C_{3} C_{4} R_{3} R_{6} + C_{4}^{2} R_{3}^{2} + 2 C_{4}^{2} R_{3} R_{6} + C_{4}^{2} R_{6}^{2}}}{2 C_{3} C_{4} R_{3} R_{6}}\)</span></p>
</div>
</div>
<div id="cell-192" class="cell" data-execution_count="117">
<div class="sourceCode cell-code" id="cb167"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb167-1"><a href="#cb167-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'the compenets that determine P3 are: </span><span class="sc">{:s}</span><span class="st"> '</span>.<span class="bu">format</span>(<span class="bu">str</span>(H_sym_P3.free_symbols)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>the compenets that determine P3 are: {R3, R6, C4, C3} </code></pre>
</div>
</div>
<div id="cell-193" class="cell" data-execution_count="118">
<div class="sourceCode cell-code" id="cb169"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb169-1"><a href="#cb169-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'P3: </span><span class="sc">{:.2f}</span><span class="st">Hz'</span>.<span class="bu">format</span>(N(H_sym_P3.subs(nominal_component_value))<span class="op">/</span>(<span class="dv">2</span><span class="op">*</span>np.pi)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>P3: -1.39Hz</code></pre>
</div>
</div>
<div id="cell-194" class="cell" data-execution_count="119">
<div class="sourceCode cell-code" id="cb171"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb171-1"><a href="#cb171-1" aria-hidden="true" tabindex="-1"></a>S_C3_H_sym_P3 <span class="op">=</span> (C3<span class="op">/</span>H_sym_P3)<span class="op">*</span>(H_sym_P3.diff(C3))</span>
<span id="cb171-2"><a href="#cb171-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'the sensitivity of P3 to C3 is: </span><span class="sc">{:.2e}</span><span class="st">'</span>.<span class="bu">format</span>(N(S_C3_H_sym_P3.subs(nominal_component_value))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>the sensitivity of P3 to C3 is: -2.83e-5</code></pre>
</div>
</div>
<div id="cell-195" class="cell" data-execution_count="120">
<div class="sourceCode cell-code" id="cb173"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb173-1"><a href="#cb173-1" aria-hidden="true" tabindex="-1"></a>S_C4_H_sym_P3 <span class="op">=</span> (C4<span class="op">/</span>H_sym_P3)<span class="op">*</span>(H_sym_P3.diff(C4))</span>
<span id="cb173-2"><a href="#cb173-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'the sensitivity of P3 to C5 is: </span><span class="sc">{:.2f}</span><span class="st">'</span>.<span class="bu">format</span>(N(S_C4_H_sym_P3.subs(nominal_component_value))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>the sensitivity of P3 to C5 is: -1.00</code></pre>
</div>
</div>
<div id="cell-196" class="cell" data-execution_count="121">
<div class="sourceCode cell-code" id="cb175"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb175-1"><a href="#cb175-1" aria-hidden="true" tabindex="-1"></a>S_R3_H_sym_P3 <span class="op">=</span> (R3<span class="op">/</span>H_sym_P3)<span class="op">*</span>(H_sym_P3.diff(R3))</span>
<span id="cb175-2"><a href="#cb175-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'the sensitivity of P3 to R3 is: </span><span class="sc">{:.2f}</span><span class="st">'</span>.<span class="bu">format</span>(N(S_R3_H_sym_P3.subs(nominal_component_value))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>the sensitivity of P3 to R3 is: -0.04</code></pre>
</div>
</div>
<div id="cell-197" class="cell" data-execution_count="122">
<div class="sourceCode cell-code" id="cb177"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb177-1"><a href="#cb177-1" aria-hidden="true" tabindex="-1"></a>S_R6_H_sym_P3 <span class="op">=</span> (R6<span class="op">/</span>H_sym_P3)<span class="op">*</span>(H_sym_P3.diff(R6))</span>
<span id="cb177-2"><a href="#cb177-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'the sensitivity of P3 to R6 is: </span><span class="sc">{:.2f}</span><span class="st">'</span>.<span class="bu">format</span>(N(S_R6_H_sym_P3.subs(nominal_component_value))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>the sensitivity of P3 to R6 is: -0.96</code></pre>
</div>
</div>
<p>In the worst case analysis below, the componets that have sensitivites greater than 0.05 are the ones that factor into the worst case analysis.</p>
</section>
</section>
<section id="component-selection" class="level3" data-number="20.4.10">
<h3 data-number="20.4.10" class="anchored" data-anchor-id="component-selection"><span class="header-section-number">20.4.10</span> Component selection</h3>
<p>The table below list each of the components used in the preamp along with a link to the <a href="https://www.digikey.com/">Digikey</a> pages for each of the components in the preamp. Digikey is a larger distributor of electronic components in the US. All the components have operating temperature ranges that exceed the normal household envirment.</p>
<p>The resistors chosen are all 1% <a href="https://en.wikipedia.org/wiki/Resistor">Metal film</a> type resistors. Metal film resistors possess good noise characteristics and low non-linearity due to a low voltage coefficient. They are also beneficial due to long-term stability.</p>
<p>The capacitors are all polypropylene <a href="https://en.wikipedia.org/wiki/Film_capacitor">Film capacitor</a> types. Polystyrene or polypropylene are considered the best for audio applications.</p>
<p>The Op Amp, <a href="https://www.ti.com/product/LM833#product-details">LM833N</a>, is a dual bipolar low noise (<span class="math inline">\(\frac {4.5nV}{\sqrt{Hz}}\)</span>), wide bandwidth (16 MHz) audio operational amplifier from <a href="https://www.ti.com/">Texas Instrments</a>.</p>
<table class="table">
<thead>
<tr class="header">
<th>Ref</th>
<th>Value</th>
<th>Description</th>
<th>Digikey PN</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Ro</td>
<td>499</td>
<td>±1% 1/4W Metal Film</td>
<td><a href="https://www.digikey.com/en/products/detail/stackpole-electronics-inc/RNF14FTD499R/1682304">RNF14FTD499RCT-ND</a></td>
</tr>
<tr class="even">
<td>Rp</td>
<td>47k</td>
<td>±1% 1/4W Metal Film</td>
<td><a href="https://www.digikey.com/en/products/detail/yageo/MFR-25FTE52-47K/9140226">13-MFR-25FTE52-47KTB-ND</a></td>
</tr>
<tr class="odd">
<td>R1</td>
<td>80.6k</td>
<td>±1% 1/4W Metal Film</td>
<td><a href="https://www.digikey.com/en/products/detail/yageo/MFR-25FBF52-80K6/13455">80.6KXBK-ND</a></td>
</tr>
<tr class="even">
<td>R2</td>
<td>58.45k</td>
<td>±1% 1/4W Metal Film</td>
<td><a href="https://www.digikey.com/en/products/detail/stackpole-electronics-inc/RNF14FTD8K45/1682435">RNF14FTD8K45CT-ND</a></td>
</tr>
<tr class="odd">
<td>R3</td>
<td>2.37k</td>
<td>±1% 1/4W Metal Film</td>
<td><a href="https://www.digikey.com/en/products/detail/yageo/MFR-25FBF52-2K37/13084">13-MFR-25FBF52-2K37-ND</a></td>
</tr>
<tr class="even">
<td>R4</td>
<td>2k</td>
<td>±1% 1/4W Metal Film</td>
<td><a href="https://www.digikey.com/en/products/detail/yageo/MFR-25FRF52-2K/14920">13-MFR-25FRF52-2KCT-ND</a></td>
</tr>
<tr class="odd">
<td>R5</td>
<td>4.3k</td>
<td>±1% 1/4W Metal Film</td>
<td><a href="https://www.digikey.com/en/products/detail/stackpole-electronics-inc/RNMF14FTC4K30/2617353">S4.3KCACT-ND</a></td>
</tr>
<tr class="even">
<td>R6</td>
<td>54.9k</td>
<td>±1% 1/4W Metal Film</td>
<td><a href="https://www.digikey.com/en/products/detail/stackpole-electronics-inc/RNF14FTD54K9/1682337">RNF14FTD54K9CT-ND</a></td>
</tr>
<tr class="odd">
<td>Co</td>
<td>200<span class="math inline">\(\mu\)</span></td>
<td>10% Film Capacitor 450V Polypropylene</td>
<td><a href="https://www.digikey.com/en/products/detail/eaton-electronics-division/EFDKS45K207F064DH/18686606">283-EFDKS45K207F064DH-ND</a></td>
</tr>
<tr class="even">
<td>Cp</td>
<td>100p</td>
<td>10% Film Capacitor 250V Polypropylene</td>
<td><a href="https://www.digikey.com/en/products/detail/wima/FKP2O101001D00KSSD/9370238">399-RSBEC0100ZA00M-ND</a></td>
</tr>
<tr class="odd">
<td>C1</td>
<td>0.039<span class="math inline">\(\mu\)</span></td>
<td>2% Film Capacitor 25V 63V Polypropylene</td>
<td><a href="https://www.digikey.com/en/products/detail/vishay-beyschlag-draloric-bc-components/BFC241643903/502846?s=N4IgjCBcoMxaBjKAzAhgGwM4FMA0IB7KAbXADYAOAFhAF18AHAFyhAGUmAnASwDsBzEAF98ZAJzwQSSGix5CJEFTBgKYgOx1GLSOy59BI8GLWTpsnPiKRSABjpGAtACYzULgFd510gFYHRq42ILYAdLYwYh7IDkA">BC2066-ND</a></td>
</tr>
<tr class="even">
<td>C3</td>
<td>0.033<span class="math inline">\(\mu\)</span></td>
<td>1% Film Capacitor 63V 100V Polypropylene</td>
<td><a href="https://www.digikey.com/en/products/detail/kemet/PHE426DJ5330FR17T0/13176493">399-PHE426DJ5330FR17T0CT-ND</a></td>
</tr>
<tr class="odd">
<td>C4</td>
<td>2<span class="math inline">\(\mu\)</span></td>
<td>10% Film Capacitor 305V 630V Polypropylene</td>
<td><a href="https://www.digikey.com/en/products/detail/epcos-tdk-electronics/B32923P3205K000/13590400">495-B32923P3205K000-ND</a></td>
</tr>
<tr class="even">
<td>U1, U2</td>
<td>LM833N</td>
<td>Audio op amp</td>
<td><a href="https://www.digikey.com/en/products/detail/texas-instruments/LM833N-NOPB/20798">296-44419-5-ND</a></td>
</tr>
</tbody>
</table>
<p>The parts in this list are considered good choices for a first pass at the bill of materials. The size of the production run and the piece part cost are also a factors which must be considered if the preamp is going to be built. One thing to notice is that Co, the 200 <span class="math inline">\(\mu\)</span> F capacitor is expensive. The use of a polypropylene film capacitor for this component is consistent with the advice of keeping all capacitors in the audio path polystyrene or polypropylene.</p>
</section>
<section id="monte-carlo-simulation" class="level3" data-number="20.4.11">
<h3 data-number="20.4.11" class="anchored" data-anchor-id="monte-carlo-simulation"><span class="header-section-number">20.4.11</span> Monte Carlo simulation</h3>
<p>In this analysis the circuit equations are solved after assigning random element values from within the tolerance band to the components. This simulates building a large number of circuits with components chosen at random from bins or reals of components during the board stuffing process. All the components are required to met their specifications, but are allowed to have some varaition accorting to theier tolerance. For example a 1% 2k resistor can range from 1980 to 2020 <span class="math inline">\(\Omega\)</span>. In addition to the components initial tolerance, the temperature coefficient and aging of paramters can also be included.</p>
<p>In this simulation, I’m only including the initial tolerances of parameters and I’m assuming the distritution is uniform. The Numpy function random.uniform is used to generate the random values within the tolerance range, however, for this function, the hight end-point value may or may not be included in the range depending on floating-point rounding, so if this is important, some adjustments to the code are required. The Numpy function random.seed is used to re-seed the random number generator.</p>
<div id="cell-199" class="cell" data-execution_count="123">
<div class="sourceCode cell-code" id="cb179"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb179-1"><a href="#cb179-1" aria-hidden="true" tabindex="-1"></a>num <span class="op">=</span> <span class="dv">20</span> <span class="co"># number of simulations to run</span></span>
<span id="cb179-2"><a href="#cb179-2" aria-hidden="true" tabindex="-1"></a>new_x_axis_range <span class="op">=</span> np.logspace(<span class="dv">1</span>, <span class="fl">5.5</span>, <span class="dv">100</span>, endpoint<span class="op">=</span><span class="va">True</span>)<span class="op">*</span><span class="dv">2</span><span class="op">*</span>np.pi</span>
<span id="cb179-3"><a href="#cb179-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-4"><a href="#cb179-4" aria-hidden="true" tabindex="-1"></a><span class="co"># make some arrays to the hold the results of each run</span></span>
<span id="cb179-5"><a href="#cb179-5" aria-hidden="true" tabindex="-1"></a>mag_ans <span class="op">=</span> np.zeros(shape<span class="op">=</span>(num,<span class="bu">len</span>(new_x_axis_range)))</span>
<span id="cb179-6"><a href="#cb179-6" aria-hidden="true" tabindex="-1"></a>phase_ans <span class="op">=</span> np.zeros(shape<span class="op">=</span>(num,<span class="bu">len</span>(new_x_axis_range)))</span>
<span id="cb179-7"><a href="#cb179-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-8"><a href="#cb179-8" aria-hidden="true" tabindex="-1"></a>component_values_tol <span class="op">=</span> nominal_component_value.copy() <span class="co"># makde a copy</span></span>
<span id="cb179-9"><a href="#cb179-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-10"><a href="#cb179-10" aria-hidden="true" tabindex="-1"></a>random.seed(a<span class="op">=</span><span class="va">None</span>, version<span class="op">=</span><span class="dv">2</span>) <span class="co"># re-seed the random number generator</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The following takes about 15 seconds to run on for num=20 on an i3 machine.</p>
<div id="cell-201" class="cell" data-execution_count="124">
<div class="sourceCode cell-code" id="cb180"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb180-1"><a href="#cb180-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>,num):</span>
<span id="cb180-2"><a href="#cb180-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-3"><a href="#cb180-3" aria-hidden="true" tabindex="-1"></a>    component_values_tol[Ro] <span class="op">=</span> random.uniform(nominal_component_value[Ro]<span class="op">-</span>nominal_component_value[Ro]<span class="op">*</span><span class="fl">0.01</span>,nominal_component_value[Ro]<span class="op">+</span>nominal_component_value[Ro]<span class="op">*</span><span class="fl">0.01</span>)</span>
<span id="cb180-4"><a href="#cb180-4" aria-hidden="true" tabindex="-1"></a>    component_values_tol[Rp] <span class="op">=</span> random.uniform(nominal_component_value[Rp]<span class="op">-</span>nominal_component_value[Rp]<span class="op">*</span><span class="fl">0.01</span>,nominal_component_value[Rp]<span class="op">+</span>nominal_component_value[Ro]<span class="op">*</span><span class="fl">0.01</span>)</span>
<span id="cb180-5"><a href="#cb180-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-6"><a href="#cb180-6" aria-hidden="true" tabindex="-1"></a>    component_values_tol[R1] <span class="op">=</span> random.uniform(nominal_component_value[R1]<span class="op">-</span>nominal_component_value[R1]<span class="op">*</span><span class="fl">0.01</span>,nominal_component_value[R1]<span class="op">+</span>nominal_component_value[R1]<span class="op">*</span><span class="fl">0.01</span>)</span>
<span id="cb180-7"><a href="#cb180-7" aria-hidden="true" tabindex="-1"></a>    component_values_tol[R2] <span class="op">=</span> random.uniform(nominal_component_value[R2]<span class="op">-</span>nominal_component_value[R2]<span class="op">*</span><span class="fl">0.01</span>,nominal_component_value[R2]<span class="op">+</span>nominal_component_value[R2]<span class="op">*</span><span class="fl">0.01</span>)    </span>
<span id="cb180-8"><a href="#cb180-8" aria-hidden="true" tabindex="-1"></a>    component_values_tol[R3] <span class="op">=</span> random.uniform(nominal_component_value[R3]<span class="op">-</span>nominal_component_value[R3]<span class="op">*</span><span class="fl">0.01</span>,nominal_component_value[R3]<span class="op">+</span>nominal_component_value[R3]<span class="op">*</span><span class="fl">0.01</span>)</span>
<span id="cb180-9"><a href="#cb180-9" aria-hidden="true" tabindex="-1"></a>    component_values_tol[R4] <span class="op">=</span> random.uniform(nominal_component_value[R4]<span class="op">-</span>nominal_component_value[R4]<span class="op">*</span><span class="fl">0.01</span>,nominal_component_value[R4]<span class="op">+</span>nominal_component_value[R4]<span class="op">*</span><span class="fl">0.01</span>)    </span>
<span id="cb180-10"><a href="#cb180-10" aria-hidden="true" tabindex="-1"></a>    component_values_tol[R5] <span class="op">=</span> random.uniform(nominal_component_value[R5]<span class="op">-</span>nominal_component_value[R5]<span class="op">*</span><span class="fl">0.01</span>,nominal_component_value[R5]<span class="op">+</span>nominal_component_value[R5]<span class="op">*</span><span class="fl">0.01</span>)</span>
<span id="cb180-11"><a href="#cb180-11" aria-hidden="true" tabindex="-1"></a>    component_values_tol[R6] <span class="op">=</span> random.uniform(nominal_component_value[R6]<span class="op">-</span>nominal_component_value[R6]<span class="op">*</span><span class="fl">0.01</span>,nominal_component_value[R6]<span class="op">+</span>nominal_component_value[R6]<span class="op">*</span><span class="fl">0.01</span>)    </span>
<span id="cb180-12"><a href="#cb180-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-13"><a href="#cb180-13" aria-hidden="true" tabindex="-1"></a>    component_values_tol[Co] <span class="op">=</span> random.uniform(nominal_component_value[Co]<span class="op">-</span>nominal_component_value[Co]<span class="op">*</span><span class="fl">0.1</span>,nominal_component_value[Co]<span class="op">+</span>nominal_component_value[Co]<span class="op">*</span><span class="fl">0.1</span>)</span>
<span id="cb180-14"><a href="#cb180-14" aria-hidden="true" tabindex="-1"></a>    component_values_tol[Cp] <span class="op">=</span> random.uniform(nominal_component_value[Cp]<span class="op">-</span>nominal_component_value[Cp]<span class="op">*</span><span class="fl">0.1</span>,nominal_component_value[Cp]<span class="op">+</span>nominal_component_value[Cp]<span class="op">*</span><span class="fl">0.1</span>)</span>
<span id="cb180-15"><a href="#cb180-15" aria-hidden="true" tabindex="-1"></a>    component_values_tol[C1] <span class="op">=</span> random.uniform(nominal_component_value[C1]<span class="op">-</span>nominal_component_value[C1]<span class="op">*</span><span class="fl">0.02</span>,nominal_component_value[C1]<span class="op">+</span>nominal_component_value[C1]<span class="op">*</span><span class="fl">0.02</span>)</span>
<span id="cb180-16"><a href="#cb180-16" aria-hidden="true" tabindex="-1"></a>    component_values_tol[C3] <span class="op">=</span> random.uniform(nominal_component_value[C3]<span class="op">-</span>nominal_component_value[C3]<span class="op">*</span><span class="fl">0.01</span>,nominal_component_value[C3]<span class="op">+</span>nominal_component_value[C3]<span class="op">*</span><span class="fl">0.01</span>)</span>
<span id="cb180-17"><a href="#cb180-17" aria-hidden="true" tabindex="-1"></a>    component_values_tol[C4] <span class="op">=</span> random.uniform(nominal_component_value[C4]<span class="op">-</span>nominal_component_value[C4]<span class="op">*</span><span class="fl">0.1</span>,nominal_component_value[C4]<span class="op">+</span>nominal_component_value[C4]<span class="op">*</span><span class="fl">0.1</span>)</span>
<span id="cb180-18"><a href="#cb180-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-19"><a href="#cb180-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># enter the element values</span></span>
<span id="cb180-20"><a href="#cb180-20" aria-hidden="true" tabindex="-1"></a>    preamp_equ_tol <span class="op">=</span> preamp_equ_sym.subs(component_values_tol)</span>
<span id="cb180-21"><a href="#cb180-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-22"><a href="#cb180-22" aria-hidden="true" tabindex="-1"></a>    U_preamp_tol <span class="op">=</span> solve(preamp_equ_tol,X)</span>
<span id="cb180-23"><a href="#cb180-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-24"><a href="#cb180-24" aria-hidden="true" tabindex="-1"></a>    H_preamp_tol <span class="op">=</span> U_preamp_tol[v2]<span class="op">/</span>U_preamp_tol[v1]</span>
<span id="cb180-25"><a href="#cb180-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-26"><a href="#cb180-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract the numerator and denominator polynomials so that the system can be defined in SciPy.</span></span>
<span id="cb180-27"><a href="#cb180-27" aria-hidden="true" tabindex="-1"></a>    H_preamp_tol_num, H_preamp_tol_denom <span class="op">=</span> fraction(H_preamp_tol) <span class="co">#returns numerator and denominator</span></span>
<span id="cb180-28"><a href="#cb180-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-29"><a href="#cb180-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># convert symbolic to numpy polynomial</span></span>
<span id="cb180-30"><a href="#cb180-30" aria-hidden="true" tabindex="-1"></a>    a2 <span class="op">=</span> np.array(Poly(H_preamp_tol_num, s).all_coeffs(), dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb180-31"><a href="#cb180-31" aria-hidden="true" tabindex="-1"></a>    b2 <span class="op">=</span> np.array(Poly(H_preamp_tol_denom, s).all_coeffs(), dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb180-32"><a href="#cb180-32" aria-hidden="true" tabindex="-1"></a>    preamp_sys_tol <span class="op">=</span> signal.TransferFunction(a2,b2)</span>
<span id="cb180-33"><a href="#cb180-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-34"><a href="#cb180-34" aria-hidden="true" tabindex="-1"></a>    w_preamp_sys_tol, mag_preamp_sys_tol, phase_preamp_sys_tol <span class="op">=</span> preamp_sys_tol.bode(w<span class="op">=</span>new_x_axis_range)</span>
<span id="cb180-35"><a href="#cb180-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb180-36"><a href="#cb180-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># save the results from each run</span></span>
<span id="cb180-37"><a href="#cb180-37" aria-hidden="true" tabindex="-1"></a>    mag_ans[i] <span class="op">=</span> mag_preamp_sys_tol</span>
<span id="cb180-38"><a href="#cb180-38" aria-hidden="true" tabindex="-1"></a>    phase_ans[i] <span class="op">=</span> phase_preamp_sys_tol</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="preamplifier-deviation-from-riaa-response-1" class="level3" data-number="20.4.12">
<h3 data-number="20.4.12" class="anchored" data-anchor-id="preamplifier-deviation-from-riaa-response-1"><span class="header-section-number">20.4.12</span> Preamplifier deviation from RIAA response</h3>
<div id="cell-203" class="cell" data-execution_count="125">
<div class="sourceCode cell-code" id="cb181"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb181-1"><a href="#cb181-1" aria-hidden="true" tabindex="-1"></a>fig, ax1 <span class="op">=</span> plt.subplots()</span>
<span id="cb181-2"><a href="#cb181-2" aria-hidden="true" tabindex="-1"></a>ax1.set_ylabel(<span class="st">'magnitude, dB'</span>)</span>
<span id="cb181-3"><a href="#cb181-3" aria-hidden="true" tabindex="-1"></a>ax1.set_xlabel(<span class="st">'frequency, Hz'</span>)</span>
<span id="cb181-4"><a href="#cb181-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-5"><a href="#cb181-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>,num):</span>
<span id="cb181-6"><a href="#cb181-6" aria-hidden="true" tabindex="-1"></a>    plt.semilogx(w_RIAA<span class="op">/</span>(<span class="dv">2</span><span class="op">*</span>np.pi), (mag_RIAA<span class="op">-</span>RIAA_gain_1kHz) <span class="op">+</span> (mag_ans[i]<span class="op">-</span>preamp_gain_1kHz),<span class="st">'-k'</span>)    <span class="co"># Bode magnitude plot</span></span>
<span id="cb181-7"><a href="#cb181-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-8"><a href="#cb181-8" aria-hidden="true" tabindex="-1"></a>ax1.tick_params(axis<span class="op">=</span><span class="st">'y'</span>)</span>
<span id="cb181-9"><a href="#cb181-9" aria-hidden="true" tabindex="-1"></a>ax1.set_ylim((<span class="op">-</span><span class="fl">0.3</span>,<span class="fl">0.3</span>))</span>
<span id="cb181-10"><a href="#cb181-10" aria-hidden="true" tabindex="-1"></a>plt.grid()</span>
<span id="cb181-11"><a href="#cb181-11" aria-hidden="true" tabindex="-1"></a>plt.axvspan(<span class="dv">20</span>, <span class="fl">20e3</span>, color<span class="op">=</span><span class="st">'y'</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb181-12"><a href="#cb181-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-13"><a href="#cb181-13" aria-hidden="true" tabindex="-1"></a><span class="co"># instantiate a second y-axes that shares the same x-axis</span></span>
<span id="cb181-14"><a href="#cb181-14" aria-hidden="true" tabindex="-1"></a>ax2 <span class="op">=</span> ax1.twinx()</span>
<span id="cb181-15"><a href="#cb181-15" aria-hidden="true" tabindex="-1"></a>color <span class="op">=</span> <span class="st">'tab:blue'</span></span>
<span id="cb181-16"><a href="#cb181-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-17"><a href="#cb181-17" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>,num):</span>
<span id="cb181-18"><a href="#cb181-18" aria-hidden="true" tabindex="-1"></a>    plt.semilogx(w_RIAA<span class="op">/</span>(<span class="dv">2</span><span class="op">*</span>np.pi), phase_RIAA<span class="op">+</span>phase_ans[i],<span class="st">':'</span>,color<span class="op">=</span>color)  <span class="co"># Bode phase plot</span></span>
<span id="cb181-19"><a href="#cb181-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-20"><a href="#cb181-20" aria-hidden="true" tabindex="-1"></a>ax2.set_ylabel(<span class="st">'phase, deg'</span>,color<span class="op">=</span>color)</span>
<span id="cb181-21"><a href="#cb181-21" aria-hidden="true" tabindex="-1"></a>ax2.tick_params(axis<span class="op">=</span><span class="st">'y'</span>, labelcolor<span class="op">=</span>color)</span>
<span id="cb181-22"><a href="#cb181-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-23"><a href="#cb181-23" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Monte Carlo runs showing deviation from RIAA curve'</span>)</span>
<span id="cb181-24"><a href="#cb181-24" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Two amplifier RIAA Phono Preamp_files/figure-html/cell-119-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>The Monte Carlo simulation shows that the preamp amplitude response deviatin from the RIAA curve can very from -0.2 to 0.3 dB over the audio band. If the performance requirement for this preamp was to be within <span class="math inline">\(\pm\)</span> 0.1 dB of the RIAA curve, then some redesign or tighter component tolerancing is required.</p>
</section>
<section id="worst-case-analysis" class="level3" data-number="20.4.13">
<h3 data-number="20.4.13" class="anchored" data-anchor-id="worst-case-analysis"><span class="header-section-number">20.4.13</span> Worst case analysis</h3>
<p>In a worst case analysis, we would look at:</p>
<ul>
<li>minimum and maximum values of the initial component tolerance<br>
</li>
<li>maximum or minumum temperature coefficients of the parameters<br>
</li>
<li>maximum aging or drift of parameter values</li>
</ul>
<p>Since we usually can’t tell by inspection which combination of minimum and maximum values will give the worst case, we can run a number of simulations in which all combination of minum and maximium variations are included. From the family of results we can look for the worst case.</p>
<p>How resistors and capactors in the preamp circuit?</p>
<div id="cell-205" class="cell" data-execution_count="126">
<div class="sourceCode cell-code" id="cb182"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb182-1"><a href="#cb182-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'number of components: </span><span class="sc">{:d}</span><span class="st">'</span>.<span class="bu">format</span>(<span class="bu">len</span>(nominal_component_value)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>number of components: 14</code></pre>
</div>
</div>
<p>How many combinations min and max combinations?</p>
<div id="cell-207" class="cell" data-execution_count="127">
<div class="sourceCode cell-code" id="cb184"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb184-1"><a href="#cb184-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'number of min and max combinations: </span><span class="sc">{:,d}</span><span class="st">'</span>.<span class="bu">format</span>(<span class="dv">2</span><span class="op">**</span><span class="dv">14</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>number of min and max combinations: 16,384</code></pre>
</div>
</div>
<p>16 thousand simulation runs to too many. From the sensitivity analysis above, only R1, R2, R3, R6, Ro, C1 and C3 are sensitive. Running all combinations of the min and max tolerance for this set is reasonable and is <span class="math inline">\(2^7=128\)</span> combinations.</p>
<p>The tolerances for each of the componts is defined below:</p>
<div id="cell-210" class="cell" data-execution_count="128">
<div class="sourceCode cell-code" id="cb186"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb186-1"><a href="#cb186-1" aria-hidden="true" tabindex="-1"></a>Tol <span class="op">=</span> {Ro:<span class="fl">0.01</span>,R1:<span class="fl">0.01</span>,R2:<span class="fl">0.01</span>,R3:<span class="fl">0.01</span>,R6:<span class="fl">0.01</span>,C1:<span class="fl">0.02</span>,C3:<span class="fl">0.01</span>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Only C1 has a tolerance other than 1%.</p>
<p>The array ‘run’ is created that consists of a binary count, with leading zeros from 0 to 127. Then the zero values are replaced with -1.</p>
<div id="cell-212" class="cell" data-execution_count="129">
<div class="sourceCode cell-code" id="cb187"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb187-1"><a href="#cb187-1" aria-hidden="true" tabindex="-1"></a>run <span class="op">=</span> []</span>
<span id="cb187-2"><a href="#cb187-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>,<span class="dv">2</span><span class="op">**</span>(<span class="bu">len</span>(Tol))):</span>
<span id="cb187-3"><a href="#cb187-3" aria-hidden="true" tabindex="-1"></a>    temp <span class="op">=</span> <span class="bu">list</span>(<span class="st">'</span><span class="sc">{:07b}</span><span class="st">'</span>.<span class="bu">format</span>(i)) <span class="co"># include leading zeros</span></span>
<span id="cb187-4"><a href="#cb187-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(temp)):</span>
<span id="cb187-5"><a href="#cb187-5" aria-hidden="true" tabindex="-1"></a>        temp[j] <span class="op">=</span> <span class="bu">int</span>(temp[j])</span>
<span id="cb187-6"><a href="#cb187-6" aria-hidden="true" tabindex="-1"></a>    run.append(temp)</span>
<span id="cb187-7"><a href="#cb187-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb187-8"><a href="#cb187-8" aria-hidden="true" tabindex="-1"></a>run <span class="op">=</span> np.asarray(run)</span>
<span id="cb187-9"><a href="#cb187-9" aria-hidden="true" tabindex="-1"></a>run <span class="op">=</span> np.where(run <span class="op">==</span> <span class="dv">0</span>, <span class="op">-</span><span class="dv">1</span>, run)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The first row of run is:</p>
<div id="cell-214" class="cell" data-execution_count="130">
<div class="sourceCode cell-code" id="cb188"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb188-1"><a href="#cb188-1" aria-hidden="true" tabindex="-1"></a>run[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="130">
<pre><code>array([-1, -1, -1, -1, -1, -1, -1])</code></pre>
</div>
</div>
<p>In the for loop below, at i = 0, run[0] would be all -1’s and this could apply the low tolerance range to the nominal component values.</p>
<div id="cell-216" class="cell" data-execution_count="131">
<div class="sourceCode cell-code" id="cb190"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb190-1"><a href="#cb190-1" aria-hidden="true" tabindex="-1"></a>run[<span class="op">-</span><span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="131">
<pre><code>array([1, 1, 1, 1, 1, 1, 1])</code></pre>
</div>
</div>
<p>The last time through the for loop, where i = 127, run[-1] is all 1’s and this would apply the high tolerance range to the nominal component values. Between i = 0 and i = 127, all combinations of minumum and maximum tolerance is appled.</p>
<div id="cell-218" class="cell" data-execution_count="132">
<div class="sourceCode cell-code" id="cb192"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb192-1"><a href="#cb192-1" aria-hidden="true" tabindex="-1"></a>new_x_axis_range <span class="op">=</span> np.logspace(<span class="dv">1</span>, <span class="fl">5.5</span>, <span class="dv">100</span>, endpoint<span class="op">=</span><span class="va">True</span>)<span class="op">*</span><span class="dv">2</span><span class="op">*</span>np.pi</span>
<span id="cb192-2"><a href="#cb192-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb192-3"><a href="#cb192-3" aria-hidden="true" tabindex="-1"></a><span class="co"># make some arrays to hold the results</span></span>
<span id="cb192-4"><a href="#cb192-4" aria-hidden="true" tabindex="-1"></a>mag_ans <span class="op">=</span> np.zeros(shape<span class="op">=</span>(<span class="bu">len</span>(run),<span class="bu">len</span>(new_x_axis_range)))</span>
<span id="cb192-5"><a href="#cb192-5" aria-hidden="true" tabindex="-1"></a>phase_ans <span class="op">=</span> np.zeros(shape<span class="op">=</span>(<span class="bu">len</span>(run),<span class="bu">len</span>(new_x_axis_range)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The following cell takes about 90 seconds to run on an i3 machine.</p>
<div id="cell-220" class="cell" data-execution_count="133">
<div class="sourceCode cell-code" id="cb193"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb193-1"><a href="#cb193-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(run)):</span>
<span id="cb193-2"><a href="#cb193-2" aria-hidden="true" tabindex="-1"></a>    component_values_tol[Ro] <span class="op">=</span> nominal_component_value[Ro]<span class="op">*</span>(<span class="dv">1</span><span class="op">+</span>run[i][<span class="dv">0</span>]<span class="op">*</span>Tol[Ro])</span>
<span id="cb193-3"><a href="#cb193-3" aria-hidden="true" tabindex="-1"></a>    component_values_tol[Rp] <span class="op">=</span> nominal_component_value[Rp]</span>
<span id="cb193-4"><a href="#cb193-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-5"><a href="#cb193-5" aria-hidden="true" tabindex="-1"></a>    component_values_tol[R1] <span class="op">=</span> nominal_component_value[R1]<span class="op">*</span>(<span class="dv">1</span><span class="op">+</span>run[i][<span class="dv">1</span>]<span class="op">*</span>Tol[R1])</span>
<span id="cb193-6"><a href="#cb193-6" aria-hidden="true" tabindex="-1"></a>    component_values_tol[R2] <span class="op">=</span> nominal_component_value[R2]<span class="op">*</span>(<span class="dv">1</span><span class="op">+</span>run[i][<span class="dv">2</span>]<span class="op">*</span>Tol[R2]) </span>
<span id="cb193-7"><a href="#cb193-7" aria-hidden="true" tabindex="-1"></a>    component_values_tol[R3] <span class="op">=</span> nominal_component_value[R3]<span class="op">*</span>(<span class="dv">1</span><span class="op">+</span>run[i][<span class="dv">3</span>]<span class="op">*</span>Tol[R3])</span>
<span id="cb193-8"><a href="#cb193-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-9"><a href="#cb193-9" aria-hidden="true" tabindex="-1"></a>    component_values_tol[R4] <span class="op">=</span> nominal_component_value[R4] </span>
<span id="cb193-10"><a href="#cb193-10" aria-hidden="true" tabindex="-1"></a>    component_values_tol[R5] <span class="op">=</span> nominal_component_value[R5]</span>
<span id="cb193-11"><a href="#cb193-11" aria-hidden="true" tabindex="-1"></a>    component_values_tol[R6] <span class="op">=</span> nominal_component_value[R6]<span class="op">*</span>(<span class="dv">1</span><span class="op">+</span>run[i][<span class="dv">4</span>]<span class="op">*</span>Tol[R6])</span>
<span id="cb193-12"><a href="#cb193-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-13"><a href="#cb193-13" aria-hidden="true" tabindex="-1"></a>    component_values_tol[Co] <span class="op">=</span> nominal_component_value[Co]</span>
<span id="cb193-14"><a href="#cb193-14" aria-hidden="true" tabindex="-1"></a>    component_values_tol[Cp] <span class="op">=</span> nominal_component_value[Cp]</span>
<span id="cb193-15"><a href="#cb193-15" aria-hidden="true" tabindex="-1"></a>    component_values_tol[C1] <span class="op">=</span> nominal_component_value[C1]<span class="op">*</span>(<span class="dv">1</span><span class="op">+</span>run[i][<span class="dv">5</span>]<span class="op">*</span>Tol[C1])</span>
<span id="cb193-16"><a href="#cb193-16" aria-hidden="true" tabindex="-1"></a>    component_values_tol[C3] <span class="op">=</span> nominal_component_value[C3]<span class="op">*</span>(<span class="dv">1</span><span class="op">+</span>run[i][<span class="dv">6</span>]<span class="op">*</span>Tol[C3])</span>
<span id="cb193-17"><a href="#cb193-17" aria-hidden="true" tabindex="-1"></a>    component_values_tol[C4] <span class="op">=</span> nominal_component_value[C4]</span>
<span id="cb193-18"><a href="#cb193-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb193-19"><a href="#cb193-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># enter the element values</span></span>
<span id="cb193-20"><a href="#cb193-20" aria-hidden="true" tabindex="-1"></a>    preamp_equ_tol <span class="op">=</span> preamp_equ_sym.subs(component_values_tol)</span>
<span id="cb193-21"><a href="#cb193-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-22"><a href="#cb193-22" aria-hidden="true" tabindex="-1"></a>    U_preamp_tol <span class="op">=</span> solve(preamp_equ_tol,X)</span>
<span id="cb193-23"><a href="#cb193-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-24"><a href="#cb193-24" aria-hidden="true" tabindex="-1"></a>    H_preamp_tol <span class="op">=</span> U_preamp_tol[v2]<span class="op">/</span>U_preamp_tol[v1]</span>
<span id="cb193-25"><a href="#cb193-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-26"><a href="#cb193-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract the numerator and denominator polynomials so that the system can be defined in SciPy.</span></span>
<span id="cb193-27"><a href="#cb193-27" aria-hidden="true" tabindex="-1"></a>    H_preamp_tol_num, H_preamp_tol_denom <span class="op">=</span> fraction(H_preamp_tol) <span class="co">#returns numerator and denominator</span></span>
<span id="cb193-28"><a href="#cb193-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-29"><a href="#cb193-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># convert symbolic to numpy polynomial</span></span>
<span id="cb193-30"><a href="#cb193-30" aria-hidden="true" tabindex="-1"></a>    a2 <span class="op">=</span> np.array(Poly(H_preamp_tol_num, s).all_coeffs(), dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb193-31"><a href="#cb193-31" aria-hidden="true" tabindex="-1"></a>    b2 <span class="op">=</span> np.array(Poly(H_preamp_tol_denom, s).all_coeffs(), dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb193-32"><a href="#cb193-32" aria-hidden="true" tabindex="-1"></a>    preamp_sys_tol <span class="op">=</span> signal.TransferFunction(a2,b2)</span>
<span id="cb193-33"><a href="#cb193-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-34"><a href="#cb193-34" aria-hidden="true" tabindex="-1"></a>    w_preamp_sys_tol, mag_preamp_sys_tol, phase_preamp_sys_tol <span class="op">=</span> preamp_sys_tol.bode(w<span class="op">=</span>new_x_axis_range)</span>
<span id="cb193-35"><a href="#cb193-35" aria-hidden="true" tabindex="-1"></a>    mag_ans[i] <span class="op">=</span> mag_preamp_sys_tol</span>
<span id="cb193-36"><a href="#cb193-36" aria-hidden="true" tabindex="-1"></a>    phase_ans[i] <span class="op">=</span> phase_preamp_sys_tol</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-221" class="cell" data-execution_count="134">
<div class="sourceCode cell-code" id="cb194"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb194-1"><a href="#cb194-1" aria-hidden="true" tabindex="-1"></a>fig, ax1 <span class="op">=</span> plt.subplots()</span>
<span id="cb194-2"><a href="#cb194-2" aria-hidden="true" tabindex="-1"></a>ax1.set_ylabel(<span class="st">'magnitude, dB'</span>)</span>
<span id="cb194-3"><a href="#cb194-3" aria-hidden="true" tabindex="-1"></a>ax1.set_xlabel(<span class="st">'frequency, Hz'</span>)</span>
<span id="cb194-4"><a href="#cb194-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-5"><a href="#cb194-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>,num):</span>
<span id="cb194-6"><a href="#cb194-6" aria-hidden="true" tabindex="-1"></a>    plt.semilogx(w_RIAA<span class="op">/</span>(<span class="dv">2</span><span class="op">*</span>np.pi), (mag_RIAA<span class="op">-</span>RIAA_gain_1kHz) <span class="op">+</span> (mag_ans[i]<span class="op">-</span>preamp_gain_1kHz),<span class="st">'-k'</span>)    <span class="co"># Bode magnitude plot</span></span>
<span id="cb194-7"><a href="#cb194-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-8"><a href="#cb194-8" aria-hidden="true" tabindex="-1"></a>ax1.tick_params(axis<span class="op">=</span><span class="st">'y'</span>)</span>
<span id="cb194-9"><a href="#cb194-9" aria-hidden="true" tabindex="-1"></a>ax1.set_ylim((<span class="op">-</span><span class="fl">0.3</span>,<span class="fl">0.4</span>))</span>
<span id="cb194-10"><a href="#cb194-10" aria-hidden="true" tabindex="-1"></a>plt.grid()</span>
<span id="cb194-11"><a href="#cb194-11" aria-hidden="true" tabindex="-1"></a>plt.axvspan(<span class="dv">20</span>, <span class="fl">20e3</span>, color<span class="op">=</span><span class="st">'y'</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb194-12"><a href="#cb194-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-13"><a href="#cb194-13" aria-hidden="true" tabindex="-1"></a><span class="co"># instantiate a second y-axes that shares the same x-axis</span></span>
<span id="cb194-14"><a href="#cb194-14" aria-hidden="true" tabindex="-1"></a>ax2 <span class="op">=</span> ax1.twinx()</span>
<span id="cb194-15"><a href="#cb194-15" aria-hidden="true" tabindex="-1"></a>color <span class="op">=</span> <span class="st">'tab:blue'</span></span>
<span id="cb194-16"><a href="#cb194-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-17"><a href="#cb194-17" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>,num):</span>
<span id="cb194-18"><a href="#cb194-18" aria-hidden="true" tabindex="-1"></a>    plt.semilogx(w_RIAA<span class="op">/</span>(<span class="dv">2</span><span class="op">*</span>np.pi), phase_RIAA<span class="op">+</span>phase_ans[i],<span class="st">':'</span>,color<span class="op">=</span>color)  <span class="co"># Bode phase plot</span></span>
<span id="cb194-19"><a href="#cb194-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-20"><a href="#cb194-20" aria-hidden="true" tabindex="-1"></a>ax2.set_ylabel(<span class="st">'phase, deg'</span>,color<span class="op">=</span>color)</span>
<span id="cb194-21"><a href="#cb194-21" aria-hidden="true" tabindex="-1"></a>ax2.tick_params(axis<span class="op">=</span><span class="st">'y'</span>, labelcolor<span class="op">=</span>color)</span>
<span id="cb194-22"><a href="#cb194-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-23"><a href="#cb194-23" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Worst Case deviation from RIAA curve'</span>)</span>
<span id="cb194-24"><a href="#cb194-24" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Two amplifier RIAA Phono Preamp_files/figure-html/cell-128-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>The results above show that the worst case tolerance conditions yeild deviations of -0.19 to 0.3 dB from the RIAA curve.</p>
</section>
</section>
<section id="summary" class="level2" data-number="20.5">
<h2 data-number="20.5" class="anchored" data-anchor-id="summary"><span class="header-section-number">20.5</span> Summary</h2>
<p>The circuit presented in this analysis is just one example of many circuits that can be found on line. For each design to be evaluated, some type of side by side analysis should be used used to down select. This notebook can be used as template for any compartivite analysis.</p>
<p>The circuit in the app note appears to have low frequency group delay that might be an issue. Also the deviation from the RIAA curve using normal component tolerances does not meet the 0.1 dB requirement. The worst case analysis also confirms this. The circuit employs an expesive 200<span class="math inline">\(\mu\)</span> Farad film capacitor. The circuit is missing a subsonic filter.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      return note.innerHTML;
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./Example-problems.html" class="pagination-link  aria-label=" example="" problems"="">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Example problems</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./Two port parameters.html" class="pagination-link" aria-label="<span class='chapter-number'>21</span>&nbsp; <span class='chapter-title'>Two port parameters</span>">
        <span class="nav-page-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Two port parameters</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>